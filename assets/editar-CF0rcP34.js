import{G as A}from"./GoogleAuthManager-YBajxLns.js";import{D as N,S as X}from"./DriveClient-CRU4MlfE.js";const Y="pwa-rpg-cache",ee=1,S="versions",L="cadastro",v="images",c={nome:"Nome",email:"Email",obs:"Observações",fotoFileId:"Imagem"};function E(e){return document.querySelector(e)}function l(e){return document.querySelector(e)}function p(e,t){const o=E("#alert");o&&(o.className=`alert alert-${e}`,o.textContent=t,o.classList.remove("d-none"),setTimeout(()=>o.classList.add("d-none"),4500))}function P(e){return new URL(window.location.href).searchParams.get(e)}function b(e){return(e??"").toString().trim()}function te(e,t){return(e??"")===(t??"")}function H(e){return!!e&&/^[A-Za-z0-9_-]{10,}$/.test(e)}function j(e){const t=b(e);if(!t)return null;const o=N.extractDriveId(t);return H(o)?`drive:${o}`:t.includes("://")?t:null}function y(){return new Promise((e,t)=>{const o=indexedDB.open(Y,ee);o.onupgradeneeded=()=>{const a=o.result;a.objectStoreNames.contains(S)||a.createObjectStore(S),a.objectStoreNames.contains(L)||a.createObjectStore(L,{keyPath:"rowIndex"}),a.objectStoreNames.contains(v)||a.createObjectStore(v)},o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)})}async function oe(e){const t=await y();return new Promise((o,a)=>{const s=t.transaction(S,"readonly").objectStore(S).get(e);s.onsuccess=()=>o(s.result??null),s.onerror=()=>a(s.error)})}async function M(e,t){const o=await y();return new Promise((a,r)=>{const n=o.transaction(S,"readwrite");n.objectStore(S).put(t,e),n.oncomplete=()=>a(),n.onerror=()=>r(n.error)})}async function ae(e){const t=await y();return new Promise((o,a)=>{const n=t.transaction(L,"readonly").objectStore(L).get(e);n.onsuccess=()=>o(n.result??null),n.onerror=()=>a(n.error)})}async function Z(e){const t=await y();return new Promise((o,a)=>{const r=t.transaction(L,"readwrite");r.objectStore(L).put(e),r.oncomplete=()=>o(),r.onerror=()=>a(r.error)})}async function J(e){const t=await y();return new Promise((o,a)=>{const n=t.transaction(v,"readonly").objectStore(v).get(e);n.onsuccess=()=>o(n.result??null),n.onerror=()=>a(n.error)})}async function F(e,t){const o=await y();return new Promise((a,r)=>{const n=o.transaction(v,"readwrite");n.objectStore(v).put(t,e),n.oncomplete=()=>a(),n.onerror=()=>r(n.error)})}async function ne(e){const t=await y();return new Promise((o,a)=>{const r=t.transaction(v,"readwrite");r.objectStore(v).delete(e),r.oncomplete=()=>o(),r.onerror=()=>a(r.error)})}async function $(e){await A.authenticate();const t=A.getAccessToken(),o=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}?alt=media`,a=await fetch(o,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok)throw new Error(`Drive media ${a.status}`);return await a.blob()}const G=l("#tab"),K=l("#rowIndex"),U=l("#nome"),V=l("#email"),T=l("#observacoes"),R=l("#imagem"),m=l("#imgPreview"),q=E("#imgPlaceholder"),k=l("#imgDelete"),re=l("#imgRetake"),z=E("#imgActions"),se=E("#imgDrop"),C=l("#fotoFileIdAtual"),ce=l("#form");let O=!1,B=null;function g(e){!m||!q||!k||!z||(m.classList.toggle("d-none",e),q.classList.toggle("d-none",!e),k.classList.toggle("d-none",e),z.classList.toggle("d-none",e))}async function Q(e){if(!m||!q||!k||!z)return;const t=j(e);if(!t){g(!0);return}const o=await J(t);if(o){m.src=URL.createObjectURL(o),g(!1);return}try{if(t.startsWith("drive:")){const n=await $(t.slice(6));await F(t,n),m.src=URL.createObjectURL(n),g(!1);return}const r=await fetch(t);if(r.ok){const n=await r.blob();await F(t,n),m.src=URL.createObjectURL(n),g(!1);return}}catch{}const a=N.extractDriveId(b(e));if(H(a)){m.src=N.viewUrl(a,256),g(!1);return}g(!0)}const I=new X,D=new N;async function ie(){const e=P("tab")||"Cadastro",t=Number(P("rowIndex")||NaN);if(G&&(G.value=e),K&&(K.value=String(t)),!Number.isInteger(t)||t<1){p("danger","Parâmetros inválidos (rowIndex precisa ser >= 1).");return}let o=await ae(t);o?(console.log("[editar] carregando do cache local"),W(o)):console.log("[editar] não há cache local para a linha; exibindo vazio até validar…");let a=I.getMetaLocal(),r=a.Cadastro;r||(console.log("[meta] não há entrada local; construindo meta local…"),a=await I.buildMetaLocalFromSheet(),r=a.Cadastro);const n=await oe("Cadastro");let s=null,d=!1;if(r&&Number.isInteger(r.index)&&r.index>=1)try{s=await I.getMetaLastModByIndexFast(r.index),console.log("[meta] remoto (fast) =",s,"(linha",r.index,")"),d=s==null||s!==n}catch(i){console.warn("[meta] fast-path falhou; usando valor local do meta:",i),s=r.lastMod||null,d=s==null||s!==n}else d=!0;if(console.log("[editar] needNetwork:",d,"localVer:",n,"remoteVer:",s),d||!o)try{await A.authenticate();const i=await I.getObjectByIndex("Cadastro",t);if(!i){p("warning","Registro não encontrado no Sheets.");return}const f={rowIndex:i.rowIndex,...i.object||{}};console.log("[editar] linha atualizada do Sheets:",f),await Z(f);const w=j(f[c.fotoFileId]??f.Foto);if(w&&!await J(w))try{if(w.startsWith("drive:")){const u=await $(w.slice(6));await F(w,u)}else{const u=await fetch(w);u.ok&&await F(w,await u.blob())}}catch{}if(W(f),s)await M("Cadastro",s),console.log("[meta] version local atualizada para:",s);else{const u=await I.upsertMeta("Cadastro");await M("Cadastro",u.lastMod)}}catch(i){console.error(i),o||p("danger","Falha ao carregar o registro.")}}function W(e){U&&(U.value=b(e[c.nome]??e.nome)),V&&(V.value=b(e[c.email]??e.email)),T&&(T.value=b(e[c.obs]??e.Observacoes??e.observacoes));const t=b(e[c.fotoFileId]??e.Foto);C&&(C.value=t),Q(t)}se?.addEventListener("click",()=>R?.click());re?.addEventListener("click",()=>R?.click());k?.addEventListener("click",()=>{O=!0,B=null,R&&(R.value=""),g(!0),p("warning","A foto será removida ao salvar.")});R?.addEventListener("change",()=>{O=!1;const e=R.files?.[0]||null;if(B=e,e&&m){const t=new FileReader;t.onload=()=>{m.src=String(t.result),g(!1)},t.readAsDataURL(e)}else{const t=C?.value||"";Q(t)}});ce?.addEventListener("submit",async e=>{e.preventDefault();const t=P("tab")||"Cadastro",o=Number(P("rowIndex")||NaN);if(!Number.isInteger(o)||o<1){p("danger","Parâmetros inválidos (rowIndex precisa ser >= 1).");return}const a=b(U?.value),r=b(V?.value),n=b(T?.value),s=C?.value||"",d=N.extractDriveId(s)||"",i={[c.nome]:a,[c.email]:r,[c.obs]:n,[c.fotoFileId]:s};try{if(await A.authenticate(),O&&d){try{await D.deleteFile?.(d)}catch{}i[c.fotoFileId]=""}if(B){if(d&&!O)try{await D.deleteFile?.(d)}catch{}const x=await D.ensurePath(["pwa-sheets-helloworld","Cadastro","Imagens"]),_=await D.uploadImage(B,x);try{await D.setPublic(_.id)}catch{}i[c.fotoFileId]=_.id}await I.updateRowByIndex(t,o,i);const f=await I.upsertMeta("Cadastro");await M("Cadastro",f.lastMod);const w={rowIndex:o,[c.nome]:a,[c.email]:r,[c.obs]:n,[c.fotoFileId]:i[c.fotoFileId]};await Z(w);const u=j(s),h=j(i[c.fotoFileId]);if(!te(u,h)){if(u)try{await ne(u)}catch{}if(h)try{if(h.startsWith("drive:")){const x=await $(h.slice(6));await F(h,x)}else{const x=await fetch(h);x.ok&&await F(h,await x.blob())}}catch{}}p("success","Registro atualizado com sucesso!"),setTimeout(()=>window.location.href="./consulta.html",700)}catch(f){console.error(f),p("danger","Falha ao salvar as alterações.")}});document.addEventListener("DOMContentLoaded",async()=>{try{await A.authenticate()}catch{}await ie()});
