import{G as U}from"./GoogleAuthManager-YBajxLns.js";import{S as G}from"./SheetsClient-BqbA6fvN.js";import{D as S}from"./DriveClient-Dwxo1zcO.js";const n=t=>document.querySelector(t),D=(t,o="warning")=>{const e=n("#alert");e&&(e.className=`alert alert-${o}`,e.textContent=t,e.classList.remove("d-none"))};function T(t,o=320){const e=document.querySelector(t);if(!e)return null;const s=()=>{e.style.height="auto";const r=e.scrollHeight;r>o?(e.style.height=`${o}px`,e.style.overflowY="auto"):(e.style.height=`${r}px`,e.style.overflowY="hidden")};return e.addEventListener("input",s),window.addEventListener("resize",s),requestAnimationFrame(s),setTimeout(s,100),{resize:s}}const m=n("#imagem"),b=n("#imgDrop"),v=n("#imgPreview"),P=n("#imgDelete"),j=n("#imgRetake"),z=n("#imgActions"),O=n("#imgPlaceholder");function A(t){O?.classList.add("d-none"),v&&(v.src=t,v.classList.remove("d-none")),P?.classList.remove("d-none"),z?.classList.remove("d-none"),b&&(b.style.minHeight="220px")}function N(){m&&(m.value=""),v&&(v.src="",v.classList.add("d-none")),P?.classList.add("d-none"),z?.classList.add("d-none"),O?.classList.remove("d-none"),b&&(b.style.minHeight="140px")}function W(){b?.addEventListener("click",t=>{t.target.closest("#imgDelete")||m?.click()}),j?.addEventListener("click",()=>m?.click()),P?.addEventListener("click",t=>{t.stopPropagation(),N()}),m?.addEventListener("change",()=>{const t=m.files?.[0];if(!t){N();return}const o=URL.createObjectURL(t);A(o)})}async function B(t){if(!t)return;await U.authenticate();const o=U.getAccessToken();if(!o)throw new Error("Token de acesso inválido para deletar arquivo.");const e=await fetch(`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(t)}`,{method:"DELETE",headers:{Authorization:`Bearer ${o}`}});if(!e.ok&&e.status!==404){const s=await e.text().catch(()=>"");console.warn("Falha ao deletar arquivo do Drive:",e.status,s)}}function q(t){const o=t.map(c=>c.toLowerCase()),e=c=>{const l=o.indexOf(c.toLowerCase());return l>=0?t[l]:null},s=c=>{const l=o.findIndex(u=>u.startsWith(c.toLowerCase()));return l>=0?t[l]:null},r=e("nome")??"Nome",w=e("email")??"Email",h=s("observa")??"Observações",p=e("imagem")??e("foto")??e("imagem url")??e("imagemurl")??"Imagem";return{H_NOME:r,H_EMAIL:w,H_OBS:h,H_IMG:p}}document.addEventListener("DOMContentLoaded",async()=>{try{await U.authenticate()}catch{}const t=new URLSearchParams(location.search),o=t.get("tab")||"Cadastro",e=Number(t.get("rowIndex")||NaN),s=n("#tab"),r=n("#rowIndex"),w=n("#nome"),h=n("#email"),p=n("#observacoes"),c=n("#form"),l=T("#observacoes",320);if(s&&(s.value=o),r&&(r.value=String(e)),!Number.isInteger(e)||e<1){D("rowIndex inválido para edição (use >= 1).","danger");return}W();const u=new G,k=new S,F=k.ensurePath(["Cadastro","Imagens"]);let L=[],d="",i=null;try{const[g,E]=await Promise.all([u.getObjectByIndex(o,e),u.getHeaders(o)]);if(!g)throw new Error("Registro não encontrado para o rowIndex informado.");L=E;const a=g.object,C=a.Nome??a?.nome??"",y=a.Email??a?.email??"",x=a.Observações??a.Observacoes??a?.observações??a?.observacoes??"";w&&(w.value=String(C)),h&&(h.value=String(y)),p&&(p.value=String(x),l?.resize());const{H_IMG:H}=q(L);d=String(a[H]||"").trim(),i=S.extractDriveId(d),i?A(S.viewUrl(i,320)):d&&d.startsWith("http")?A(d):N()}catch(g){D(g?.message||"Erro ao carregar registro para edição.","danger");return}c?.addEventListener("submit",async g=>{g.preventDefault();try{const E=(w?.value||"").trim(),a=(h?.value||"").trim(),C=(p?.value||"").trim();L.length||(L=await u.getHeaders(o));const{H_NOME:y,H_EMAIL:x,H_OBS:H,H_IMG:R}=q(L),f={};y&&(f[y]=E),x&&(f[x]=a),H&&(f[H]=C);const I=m?.files?.[0]||null;if(!!O&&!O.classList.contains("d-none")&&!I&&(i&&await B(i),i=null,d="",f[R]=""),I){if(!I.type.startsWith("image/"))throw new Error("Selecione uma imagem válida.");if(I.size>5*1024*1024)throw new Error("Imagem muito grande (máx. 5 MB).");i&&await B(i);const $=await F,M=await k.uploadImage(I,$);await k.setPublic(M.id);const _=S.viewUrl(M.id);f[R]=_,i=M.id,d=_}await u.updateRowByIndex(o,e,f),D("Registro atualizado com sucesso!","success")}catch(E){D(E?.message||"Erro ao salvar alterações.","danger")}})});
