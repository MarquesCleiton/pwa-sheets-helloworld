import{G as P}from"./GoogleAuthManager-YBajxLns.js";import{S as j}from"./SheetsClient-BqbA6fvN.js";import{l as q}from"./loadNavbar-6w5EyZrw.js";import"./navigation-Cl-AB2MO.js";class d{fields;appRootName;static ROOT_CACHE_KEY="drive:appRootId";static PATH_PREFIX="drive:path:";static CACHE_TTL_MS=1440*60*1e3;constructor(e="id,name,mimeType,webViewLink,webContentLink,thumbnailLink",t="pwa-sheets-helloworld"){this.fields=e,this.appRootName=t}async getAccessToken(){await P.authenticate();const e=P.getAccessToken();if(!e)throw new Error("Token de acesso inválido (Drive).");return e}async request(e,t){const o=await this.getAccessToken(),n=t?.body instanceof FormData,a=await fetch(e,{...t,headers:{Authorization:`Bearer ${o}`,...n?{}:{"Content-Type":"application/json"},...t?.headers||{}}});if(!a.ok){let i="";try{i=await a.text()}catch{}try{i=JSON.parse(i)?.error?.message||i}catch{}throw new Error(`Drive ${a.status}: ${i||a.statusText}`)}const s=a.headers.get("content-type")||"";if(a.status!==204)return s.includes("application/json")?await a.json():await a.text()}getCache(e){try{const t=localStorage.getItem(e);if(!t)return null;const{id:o,ts:n}=JSON.parse(t);return Date.now()-Number(n)>d.CACHE_TTL_MS?null:o}catch{return null}}setCache(e,t){try{localStorage.setItem(e,JSON.stringify({id:t,ts:Date.now()}))}catch{}}async findFolderInParent(e,t){const o=[`name='${t.replace(/'/g,"\\'")}'`,"mimeType='application/vnd.google-apps.folder'","trashed=false",`'${e}' in parents`].join(" and "),n=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(o)}&fields=files(id,name)&pageSize=1`;return((await this.request(n)).files||[])[0]??null}async createFolder(e,t){return await this.request("https://www.googleapis.com/drive/v3/files?fields=id,name",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,parents:[e],mimeType:"application/vnd.google-apps.folder"})})}async ensureAppRoot(){const e=this.getCache(d.ROOT_CACHE_KEY);if(e)return e;const t=[`name='${this.appRootName.replace(/'/g,"\\'")}'`,"mimeType='application/vnd.google-apps.folder'","trashed=false","'root' in parents"].join(" and "),o=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(t)}&fields=files(id,name)&pageSize=1`,a=((await this.request(o)).files||[])[0];if(a)return this.setCache(d.ROOT_CACHE_KEY,a.id),a.id;const s=await this.createFolder("root",this.appRootName);return this.setCache(d.ROOT_CACHE_KEY,s.id),s.id}async ensurePath(e){const t=await this.ensureAppRoot(),o=(Array.isArray(e)?e:e.split("/")).map(s=>s.trim()).filter(Boolean);let n=t,a=[];for(const s of o){a.push(s);const i=`${d.PATH_PREFIX}${this.appRootName}/${a.join("/")}`,l=this.getCache(i);if(l){n=l;continue}const m=await this.findFolderInParent(n,s);if(m){this.setCache(i,m.id),n=m.id;continue}const C=await this.createFolder(n,s);this.setCache(i,C.id),n=C.id}return n}async findRecentByName(e,t,o){const n=new Date(o).toISOString(),a=`name='${t.replace(/'/g,"\\'")}' and '${e}' in parents and trashed=false and createdTime>'${n}'`,s=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(a)}&orderBy=createdTime desc&fields=files(id)&pageSize=1`;return((await this.request(s)).files||[])[0]??null}async uploadImage(e,t){const o=Date.now(),n={name:e.name,mimeType:e.type||"application/octet-stream",parents:[t]},a=new FormData;a.append("metadata",new Blob([JSON.stringify(n)],{type:"application/json; charset=UTF-8"})),a.append("file",e);const s="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id";try{return await this.request(s,{method:"POST",body:a})}catch{const i=await this.findRecentByName(t,e.name,o-6e4);return i||await this.uploadImageResumable(e,t)}}async uploadImageResumable(e,t){const o=await this.getAccessToken(),n=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable&fields=id",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify({name:e.name,parents:[t],mimeType:e.type||"application/octet-stream"})});if(!n.ok)throw new Error(`Init resumable: ${await n.text()}`);const a=n.headers.get("Location");if(!a)throw new Error("Resumable: header Location ausente.");const s=await fetch(a,{method:"PUT",headers:{"Content-Type":e.type||"application/octet-stream"},body:e});if(!s.ok)throw new Error(`PUT resumable: ${await s.text()}`);return await s.json()}async setPublic(e){const t=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}/permissions`;await this.request(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})})}static viewUrl(e,t){return t?`https://lh3.googleusercontent.com/d/${encodeURIComponent(e)}=s${t}`:`https://lh3.googleusercontent.com/d/${encodeURIComponent(e)}`}static extractDriveId(e){const t=(e||"").trim();if(!t)return null;if(!t.includes("://"))return t;const o=t.match(/[?&]id=([a-zA-Z0-9_-]+)/);if(o)return o[1];const n=t.match(/\/d\/([a-zA-Z0-9_-]+)/);if(n)return n[1];const a=t.match(/\/download\?id=([a-zA-Z0-9_-]+)/);return a?a[1]:null}}const r=c=>document.querySelector(c),x=r("#cadastroForm"),B=r("#nome"),F=r("#email"),D=r("#obs"),p=r("#imagem"),T=r("#imgDrop"),f=r("#imgPreview"),E=r("#imgDelete"),_=r("#imgRetake"),U=r("#imgActions"),H=r("#imgPlaceholder"),v=r("#authAlert"),$=r("#status"),h=r("#btnSalvar");function b(c,e="warning"){v&&(v.className=`alert alert-${e}`,v.textContent=c,v.classList.remove("d-none"))}function z(){v?.classList.add("d-none")}function y(c){$&&($.textContent=c)}function M(c){H?.classList.add("d-none"),f&&(f.src=c,f.classList.remove("d-none")),E?.classList.remove("d-none"),U?.classList.remove("d-none"),T&&(T.style.minHeight="220px")}function N(){p&&(p.value=""),f&&(f.src="",f.classList.add("d-none")),E?.classList.add("d-none"),U?.classList.add("d-none"),H?.classList.remove("d-none"),T&&(T.style.minHeight="140px")}document.addEventListener("DOMContentLoaded",()=>{q(),T?.addEventListener("click",e=>{e.target.closest("#imgDelete")||p?.click()}),_?.addEventListener("click",()=>p?.click()),E?.addEventListener("click",e=>{e.stopPropagation(),N()}),p?.addEventListener("change",()=>{const e=p.files?.[0];if(!e){N();return}const t=URL.createObjectURL(e);M(t)}),document.getElementById("btnSair")?.addEventListener("click",()=>{try{localStorage.removeItem("user"),localStorage.removeItem("accessToken")}catch{}window.location.href="/index.html"})});const R=new d,J=R.ensurePath(["Cadastro","Imagens"]);let S=!1;x?.addEventListener("submit",async c=>{if(c.preventDefault(),S)return;S=!0,z(),y("");const e="Cadastro",t=new j;h&&(h.disabled=!0,h.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>Salvando…');try{const o=(B?.value||"").trim(),n=(F?.value||"").trim(),a=(D?.value||"").trim();if(!o||!n){b("Preencha Nome e E-mail.","warning");return}const[s,i]=await Promise.all([t.getHeaders(e),J]),l=p?.files?.[0]||null;let m="";if(l){if(!l.type.startsWith("image/"))throw new Error("Selecione uma imagem válida.");if(l.size>5*1024*1024)throw new Error("Imagem muito grande (máx. 5 MB).");y("Enviando imagem…");const u=await R.uploadImage(l,i);await R.setPublic(u.id),m=d.viewUrl(u.id)}const C=s.map(u=>u.toLowerCase()),g=u=>{const k=C.indexOf(u.toLowerCase());return k>=0?s[k]:null},w={},L=g("Nome");L&&(w[L]=o);const A=g("Email");A&&(w[A]=n);const I=g("Observações")||g("Observacoes");I&&(w[I]=a);const O=g("Imagem");O&&m&&(w[O]=m),y("Gravando cadastro…"),await t.appendRowByHeader(e,w),b("Cadastro criado com sucesso!","success"),y("Cadastro criado com sucesso!")}catch(o){b(o?.message||"Erro ao salvar cadastro.","danger"),y("")}finally{S=!1,h&&(h.disabled=!1,h.innerHTML='<i class="bi bi-check2-circle me-1"></i>Salvar')}});
