import{G as D}from"./GoogleAuthManager-lBYSKgkx.js";import{D as x,S as V}from"./DriveClient-BojxZt8p.js";const d={DRIVE_ROOT_ID:"1qWCNneRI06SuL_VjUqn0dobAYea-HSew",DRIVE_SHARED_ID:"",APP_ROOT_NAME:"pwa-sheets-helloworld",TAB:"Cadastro",PRELOAD_IMAGES:!0},$=new x({rootFolderId:"1qWCNneRI06SuL_VjUqn0dobAYea-HSew",appRootName:"pwa-sheets-helloworld"}),p=new V,f={nome:"Nome",email:"Email",obs:"Observações",foto:"Imagem"},L=document.querySelector("#cards"),W=document.querySelector("#btnAtualizar"),j=document.querySelector("#busca"),E=document.querySelector("#alert");function R(t,r){E&&(E.className=`alert alert-${t}`,E.textContent=r,E.classList.remove("d-none"),setTimeout(()=>E.classList.add("d-none"),4e3))}async function S(){try{const t=window.google;return!t||!t.accounts?(console.info("[auth] GIS não disponível ainda → mantendo local-first."),!1):(await D.authenticate(),!0)}catch(t){return console.info("[auth] não foi possível autenticar agora; seguindo com cache.",t),!1}}const z="pwa-rpg-cache",G=1,A="versions",w="cadastro",y="images";function b(){return new Promise((t,r)=>{const e=indexedDB.open(z,G);e.onupgradeneeded=()=>{const o=e.result;o.objectStoreNames.contains(A)||o.createObjectStore(A),o.objectStoreNames.contains(w)||o.createObjectStore(w,{keyPath:"rowIndex"}),o.objectStoreNames.contains(y)||o.createObjectStore(y)},e.onsuccess=()=>t(e.result),e.onerror=()=>r(e.error)})}async function H(t){const r=await b();return new Promise((e,o)=>{const n=r.transaction(A,"readonly").objectStore(A).get(t);n.onsuccess=()=>e(n.result??null),n.onerror=()=>o(n.error)})}async function O(t,r){const e=await b();return new Promise((o,a)=>{const n=e.transaction(A,"readwrite");n.objectStore(A).put(r,t),n.oncomplete=()=>o(),n.onerror=()=>a(n.error)})}async function P(){const t=await b();return new Promise((r,e)=>{const n=t.transaction(w,"readonly").objectStore(w).getAll();n.onsuccess=()=>r(n.result??[]),n.onerror=()=>e(n.error)})}async function Y(t){const r=await b();return new Promise((e,o)=>{const a=r.transaction(w,"readwrite"),n=a.objectStore(w);n.clear();for(const u of t)n.put(u);a.oncomplete=()=>e(),a.onerror=()=>o(a.error)})}async function K(t){const r=await b();return new Promise((e,o)=>{const n=r.transaction(w,"readonly").objectStore(w).get(t);n.onsuccess=()=>e(n.result??null),n.onerror=()=>o(n.error)})}async function Z(t){const r=await b();return new Promise((e,o)=>{const a=r.transaction(w,"readwrite");a.objectStore(w).delete(t),a.oncomplete=()=>e(),a.onerror=()=>o(a.error)})}async function k(t){const r=await b();return new Promise((e,o)=>{const n=r.transaction(y,"readonly").objectStore(y).get(t);n.onsuccess=()=>e(n.result??null),n.onerror=()=>o(n.error)})}async function C(t,r){const e=await b();return new Promise((o,a)=>{const n=e.transaction(y,"readwrite");n.objectStore(y).put(r,t),n.oncomplete=()=>o(),n.onerror=()=>a(n.error)})}async function J(t){const r=await b();return new Promise((e,o)=>{const a=r.transaction(y,"readwrite");a.objectStore(y).delete(t),a.oncomplete=()=>e(),a.onerror=()=>o(a.error)})}function m(t){return(t??"").toString().trim()}function B(t){return!!t&&/^[A-Za-z0-9_-]{10,}$/.test(t)}function N(t){const r=m(t);if(!r)return null;const e=x.extractDriveId(r);return B(e)?`drive:${e}`:r.includes("://")?r:null}function T(t){const r=Object.values(t).map(o=>m(o));if(r.length===0)return!0;const e=r.filter(o=>o!=="");return e.length>0&&e.every(o=>o==="-")}async function F(t){await D.authenticate();const r=D.getAccessToken(),e=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(t)}?alt=media`,o=await fetch(e,{headers:{Authorization:`Bearer ${r}`}});if(!o.ok)throw new Error(`Drive media ${o.status}`);return await o.blob()}function M(t,r=""){if(!L)return;const e=r.toLowerCase();L.innerHTML="";const o=t.filter(a=>{const n=m(a[f.nome]).toLowerCase(),u=m(a[f.email]).toLowerCase(),c=m(a[f.obs]??a.Observacoes).toLowerCase();return!e||n.includes(e)||u.includes(e)||c.includes(e)});for(const a of o){const n=m(a[f.nome]),u=m(a[f.email]),c=m(a[f.obs]??a.Observacoes),i=m(a[f.foto]??a.Foto),l=document.createElement("div");l.className="card shadow-sm mb-3",l.dataset.rowIndex=String(a.rowIndex);const v=document.createElement("div");v.className="card-img-top d-flex align-items-center justify-content-center",v.style.minHeight="140px";const s=document.createElement("img");s.style.maxHeight="140px",s.style.objectFit="cover",s.loading="lazy",(async()=>{const g=N(i);if(g){const _=await k(g);if(_)s.src=URL.createObjectURL(_);else try{if(g.startsWith("drive:")&&await S()){const I=await F(g.slice(6));await C(g,I),s.src=URL.createObjectURL(I)}else if(g.startsWith("drive:"))B(i)&&(s.src=x.viewUrl(i,256));else{const I=await fetch(g);if(I.ok){const q=await I.blob();await C(g,q),s.src=URL.createObjectURL(q)}else B(i)&&(s.src=x.viewUrl(i,256))}}catch{B(i)&&(s.src=x.viewUrl(i,256))}}else s.alt="Sem imagem"})(),v.appendChild(s),l.appendChild(v);const h=document.createElement("div");h.className="card-body",h.innerHTML=`
      <h5 class="card-title mb-1">${n||"(sem nome)"}</h5>
      <div class="text-muted small mb-2">${u||""}</div>
      <p class="card-text">${c||""}</p>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-primary" href="./editar.html?tab=${encodeURIComponent(d.TAB)}&rowIndex=${a.rowIndex}">Editar</a>
        <button class="btn btn-sm btn-outline-danger" data-action="delete" data-row="${a.rowIndex}">Excluir</button>
      </div>
    `,l.appendChild(h),L.appendChild(l)}}async function U(){const r=(await P()).filter(c=>!T(c));M(r);let e=p.getMetaLocal(),o=e[d.TAB];if(!o)if(await S())console.log("[meta] primeira sincronização de índices…"),e=await p.buildMetaLocalFromSheet(),o=e[d.TAB];else{console.log("[meta] sem auth; permanecendo com dados locais.");return}const a=await H(d.TAB);let n=null;if(o&&o.index>=1)if(await S())try{n=await p.getMetaLastModByIndexFast(o.index),console.log("[meta] remoto (fast) =",n,"linha:",o.index)}catch(c){console.warn("[meta] fast-path falhou; usando cached:",c),n=o.lastMod||null}else n=o.lastMod||null;const u=n==null||n!==a;if(console.log("[consulta] needSync?",u,"localVer:",a,"remoteVer:",n),u&&await S())try{console.time("[consulta] fetch Sheets Cadastro");const c=await p.getObjectsWithIndex(d.TAB);console.timeEnd("[consulta] fetch Sheets Cadastro");const i=[];for(const l of c)T(l.object)||i.push({rowIndex:l.rowIndex,...l.object});if(console.log("[consulta] ativos:",i.length,"de",c.length),await Y(i),d.PRELOAD_IMAGES){console.time("[consulta] preload imagens");for(const l of i){const v=l[f.foto]??l.Foto,s=N(v);if(s&&!await k(s))try{if(s.startsWith("drive:")&&await S()){const h=await F(s.slice(6));await C(s,h)}else if(!s.startsWith("drive:")){const h=await fetch(s);h.ok&&await C(s,await h.blob())}}catch{}}console.timeEnd("[consulta] preload imagens")}if(n)await O(d.TAB,n);else{const l=await p.upsertMeta(d.TAB);await O(d.TAB,l.lastMod)}M(i,j?.value||""),R("success","Dados atualizados.")}catch(c){console.error(c),R("danger","Falha ao atualizar dados do Sheets.")}}async function Q(t){if(!(!Number.isInteger(t)||t<1||!confirm("Confirma excluir este registro?")))try{if(!await S()){R("warning","Não foi possível autenticar agora.");return}const e=await K(t),o=e?m(e[f.foto]??e.Foto):"",a=x.extractDriveId(o)||"";if(a){try{console.log("[delete] apagando imagem no Drive:",a),await $.deleteFile(a)}catch(i){console.warn("[delete] falha ao apagar imagem no Drive:",i)}const c=N(o);if(c)try{await J(c)}catch{}}console.log("[delete] softDeleteRowByIndex:",d.TAB,t),await p.softDeleteRowByIndex(d.TAB,t);const n=await p.upsertMeta(d.TAB);await O(d.TAB,n.lastMod),await Z(t);const u=L?.querySelector(`[data-row-index="${t}"]`);u?.parentElement?.removeChild(u),R("success","Registro excluído.")}catch(e){console.error(e),R("danger","Falha ao excluir registro.")}}L?.addEventListener("click",t=>{const e=t.target.closest("[data-action='delete']");if(e){const o=Number(e.getAttribute("data-row")||"0");Q(o)}});W?.addEventListener("click",async()=>{await U()});j?.addEventListener("input",async()=>{const r=(await P()).filter(e=>!T(e));M(r,j.value)});document.addEventListener("DOMContentLoaded",async()=>{console.time("[consulta] boot");try{await D.authenticate()}catch{}await U(),console.timeEnd("[consulta] boot")});
