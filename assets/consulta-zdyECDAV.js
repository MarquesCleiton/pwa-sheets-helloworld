import{n as _}from"./navigation-BiZBkmgm.js";import{DriveClient as H}from"./DriveClient-PNd5-b1r.js";import{l as K,S as Z}from"./loadNavbar-CnyS9KZm.js";function V(n){if(!n)return null;const o=/\/d\/([a-zA-Z0-9_-]{10,})/,c=/id=([a-zA-Z0-9_-]{10,})/,l=/^([a-zA-Z0-9_-]{10,})$/;let a=n.match(o);return a||(a=n.match(c),a)||(a=n.match(l),a)?a[1]:null}window.deleteDriveFile=async n=>{const o=V(n);if(!o){console.warn("Não foi possível extrair ID:",n);return}await new H().deleteFile(o),console.log("[Drive] excluindo arquivo do Drive:",o)};const G="pwa-sheets-cache",J=2,x="users",y="images";class W{db=null;async open(){return this.db?this.db:(this.db=await new Promise((o,c)=>{const l=indexedDB.open(G,J);l.onupgradeneeded=()=>{const a=l.result;a.objectStoreNames.contains(x)||a.createObjectStore(x,{keyPath:"key"}).createIndex("by_email","email"),a.objectStoreNames.contains(y)||a.createObjectStore(y,{keyPath:"key"})},l.onsuccess=()=>o(l.result),l.onerror=()=>c(l.error)}),this.db)}async getAllUsers(){console.log("[CacheDB] getAllUsers(): lendo cache...");const o=await this.open();return new Promise((c,l)=>{const u=o.transaction(x,"readonly").objectStore(x).getAll();u.onsuccess=()=>{const i=(u.result||[]).map(v=>v.data);console.log(`[CacheDB] getAllUsers(): ${i.length} registro(s) do cache`),c(i)},u.onerror=()=>l(u.error)})}async putUsers(o){console.log(`[CacheDB] putUsers(): gravando ${o.length} registro(s) no cache...`);const c=await this.open();return new Promise((l,a)=>{const d=c.transaction(x,"readwrite"),u=d.objectStore(x);u.clear();for(const i of o){const v=(i.email||i.nome||"").toLowerCase()||`row_${D(JSON.stringify(i))}`;u.put({key:v,email:i.email||null,data:i})}d.oncomplete=()=>{console.log("[CacheDB] putUsers(): concluído."),l()},d.onerror=()=>a(d.error)})}}class j{constructor(o){this.getDB=o}db=null;async dbp(){return this.db?this.db:(this.db=await this.getDB(),this.db)}async get(o){const c=await this.dbp();return new Promise((l,a)=>{const i=c.transaction(y,"readonly").objectStore(y).get(o);i.onsuccess=()=>l(i.result&&i.result.blob||null),i.onerror=()=>a(i.error)})}async put(o,c){const l=await this.dbp();return new Promise((a,d)=>{const u=l.transaction(y,"readwrite");u.objectStore(y).put({key:o,blob:c}),u.oncomplete=()=>a(),u.onerror=()=>d(u.error)})}async del(o){const c=await this.dbp();return new Promise((l,a)=>{const d=c.transaction(y,"readwrite");d.objectStore(y).delete(o),d.oncomplete=()=>l(),d.onerror=()=>a(d.error)})}}function D(n){let o=0,c=0;for(;c<n.length;)o=(o<<5)-o+n.charCodeAt(c++)|0;return Math.abs(o)}function F(n){return n.fotoId?`id:${n.fotoId}`:n.fotoUrl?`url:${D(n.fotoUrl)}`:null}async function Q(n){const o=await fetch(n,{cache:"no-store"});if(!o.ok)throw new Error(`Falha ao baixar imagem (${o.status})`);return await o.blob()}document.addEventListener("DOMContentLoaded",()=>{console.log("[Consulta] DOMContentLoaded → init()"),K();const n=document.getElementById("tbody"),o=document.getElementById("q"),c=document.getElementById("btnAtualizar"),l=document.getElementById("alert");if(!n){console.error("[Consulta] ERRO: tbody não encontrado!");return}const a=(t,e="warning")=>{l&&(l.textContent=t,l.className=`alert alert-${e}`,l.classList.remove("d-none"))},d=()=>l?.classList.add("d-none"),u=t=>{c&&(c.disabled=t,c.textContent=t?"Carregando...":"Atualizar")},i=new W,v=new j(()=>i.open()),p=new Z;let b=[];const M=(t,e)=>({rowIndex:t,nome:e?.Nome??e?.nome??"",email:e?.Email??e?.email??"",observacoes:e?.Observacoes??e?.Observações??e?.observacoes??e?.observações??"",fotoUrl:e?.FotoUrl??e?.fotoUrl??e?.ImageUrl??e?.imageUrl??e?.Imagem??e?.Foto??null,fotoId:e?.FotoId??e?.fotoId??e?.ImageId??e?.imageId??null}),E=t=>`<span class="avatar-fallback">${I(t)}</span>`,A=()=>'<span class="avatar-fallback" aria-busy="true">…</span>';function B(t){const e=(String(t.nome||t.email||"?")[0]||"?").toUpperCase(),s=F(t);return!t.fotoUrl||!s?E(e):`
      <img class="avatar d-none" alt="" loading="lazy"
           data-img-key="${I(s)}"
           data-img-src="${I(t.fotoUrl)}" />
      ${A()}
    `}async function z(){if(!n)return;const t=Array.from(n.querySelectorAll("img[data-img-key][data-img-src]")),e=new Set;for(const s of t){const r=s.dataset.imgKey,w=s.dataset.imgSrc;if(!e.has(r)){e.add(r);try{let g=await v.get(r);g||(g=await Q(w),await v.put(r,g));const m=URL.createObjectURL(g),f=Array.from(n.querySelectorAll("img[data-img-key]")).filter(h=>h.dataset.imgKey===r);for(const h of f){h.src=m,h.classList.remove("d-none");const C=h.nextElementSibling;C&&C.classList.contains("avatar-fallback")&&C.remove()}}catch(g){console.warn("[Consulta] falha ao hidratar imagem:",g);const m=Array.from(n.querySelectorAll("img[data-img-key]")).filter(f=>f.dataset.imgKey===r);for(const f of m){const C=f.closest("tr")?.querySelector("td:nth-child(2)"),P=(String(C?.textContent||"?")[0]||"?").toUpperCase(),U=f.parentElement;f.remove(),U.insertAdjacentHTML("afterbegin",E(P));const k=U.querySelector(".avatar-fallback[aria-busy='true']");k&&k.remove()}}}}}const S=()=>{console.log("[Consulta] render(): registros em memória =",b.length),n.innerHTML="";const t=(o?.value||"").trim().toLowerCase(),e=t?b.filter(s=>(s.nome||"").toLowerCase().includes(t)||(s.email||"").toLowerCase().includes(t)||(s.observacoes||"").toLowerCase().includes(t)):b;for(const s of e){const r=document.createElement("tr"),w=document.createElement("td");w.innerHTML=B(s);const g=document.createElement("td");g.textContent=s.nome||"—";const m=document.createElement("td");if(s.email){const C=document.createElement("a");C.href=`mailto:${s.email}`,C.textContent=s.email,m.appendChild(C)}else m.textContent="—";const f=document.createElement("td");f.textContent=s.observacoes||"—";const h=document.createElement("td");h.className="text-end actions",h.innerHTML=`
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-primary" data-action="edit" data-row="${s.rowIndex}">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-outline-danger" data-action="delete" data-row="${s.rowIndex}">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      `,r.appendChild(w),r.appendChild(g),r.appendChild(m),r.appendChild(f),r.appendChild(h),n.appendChild(r)}z()},O=async()=>{console.log("[Consulta] fetchUsersFromSheets(): lendo do Sheets (Cadastro)...");const t=await p.getObjectsWithIndex("Cadastro"),s=t.filter(r=>!$(r.object)).map(r=>M(r.rowIndex,r.object));return console.log("[Consulta] fetchUsersFromSheets(): recebidos =",t.length," | ativos =",s.length," | excluídos =",t.length-s.length),s};function $(t){const e=Object.values(t??{});return e.length?e.every(s=>String(s??"").trim()==="-"):!1}const N=async()=>{console.log("[Consulta] ensureMetaLocalEntry(): verificando cache local de metadados...");let t=p.getMetaLocal(),e=t.Cadastro;return e?(console.log("[Consulta] meta local encontrado:",e),e):(console.log("[Consulta] reconstruindo meta local (buildMetaLocalFromSheet)..."),t=await p.buildMetaLocalFromSheet(),e=t.Cadastro,console.log("[Consulta] meta após rebuild:",e),e)},R=async()=>{const t=await N();if(!t)return console.warn("[Consulta] sem meta 'Cadastro' → considerar atualização."),!0;const e=await p.getMetaLastModByIndexFast(t.index);return console.log("[Consulta] meta local:",t.lastMod," | meta remoto:",e),!!e&&e>t.lastMod},q=async t=>{console.log("[Consulta] refreshFromRemote():",t),u(!0),a(t,"info");try{const e=await O();await i.putUsers(e),b=e,S(),typeof p.upsertMetaLocal=="function"?(console.log("[Consulta] upsertMetaLocal('Cadastro') para alinhar cache local…"),await p.upsertMetaLocal("Cadastro")):(console.log("[Consulta] buildMetaLocalFromSheet() (fallback) …"),await p.buildMetaLocalFromSheet()),a("Dados atualizados.","success"),setTimeout(d,1500)}catch(e){console.error("[Consulta] refreshFromRemote(): erro",e),a(e?.message||"Falha ao atualizar dados do Sheets.","warning")}finally{u(!1)}},L=async t=>{console.log("[Consulta] checkForUpdates(): force =",t);try{t&&a("Verificando atualizações...","info"),await R()?(console.log("[Consulta] atualização detectada."),await q("Nova versão encontrada — atualizando...")):t?(a("Dados já estão atualizados.","success"),setTimeout(d,1500)):d()}catch(e){console.error("[Consulta] checkForUpdates(): erro",e),a("Não foi possível verificar atualizações agora.","warning")}};n.addEventListener("click",async t=>{const e=t.target.closest("button[data-action]");if(!e)return;const s=e.dataset.action,r=Number(e.dataset.row);if(!Number.isFinite(r)||r<1)return;const w=b.find(g=>g.rowIndex===r);if(w){if(s==="edit"){console.log("[Consulta] editar:",w),_(`src/presentation/pages/editar.html?rowIndex=${r}`);return}if(s==="delete"){if(console.log("[Consulta] excluir:",w),!confirm("Confirma excluir este cadastro? Essa ação é irreversível."))return;u(!0),a("Excluindo cadastro...","info");try{const m=w.fotoId||w.fotoUrl;m&&typeof window.deleteDriveFile=="function"&&(console.log("[Consulta] Excluindo arquivo no Drive:",m),await window.deleteDriveFile(m));const f=F(w);if(f)try{await v.del(f)}catch{}console.log("[Consulta] Soft delete no Sheets, rowIndex =",r),await p.softDeleteRowByIndex("Cadastro",r),console.log("[Consulta] Atualizando cache local (removendo registro)..."),b=b.filter(h=>h.rowIndex!==r),await i.putUsers(b),S(),console.log("[Consulta] upsertMetaSheet('Cadastro')..."),typeof p.upsertMetaSheet=="function"&&await p.upsertMetaSheet("Cadastro"),a("Cadastro excluído.","success"),setTimeout(d,1500)}catch(m){console.error("[Consulta] Erro ao excluir:",m),a(m?.message||"Falha ao excluir cadastro.","warning")}finally{u(!1)}}}});const T=async()=>{console.log("[Consulta] init(): cache-first");const t=await i.getAllUsers();t.length&&(b=t,S()),await L(!1)};c?.addEventListener("click",()=>L(!0)),o?.addEventListener("input",()=>{console.log("[Consulta] filtro:",o?.value),S()}),T()});function I(n){return String(n??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;")}
