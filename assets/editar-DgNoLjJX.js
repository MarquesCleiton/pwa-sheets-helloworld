import{G as j}from"./GoogleAuthManager-lBYSKgkx.js";import{D as P,S as te}from"./DriveClient-BojxZt8p.js";const l="Cadastro",oe="pwa-rpg-cache",ae=1,F="versions",A="cadastro",I="images",i={nome:"Nome",email:"Email",obs:"Observações",fotoFileId:"Imagem"};function q(e){return document.querySelector(e)}function u(e){return document.querySelector(e)}function p(e,t){const o=q("#alert");o&&(o.className=`alert alert-${e}`,o.textContent=t,o.classList.remove("d-none"),setTimeout(()=>o.classList.add("d-none"),4500))}function k(e){return new URL(window.location.href).searchParams.get(e)}function g(e){return(e??"").toString().trim()}function ne(e,t){return(e??"")===(t??"")}function Z(e){return!!e&&/^[A-Za-z0-9_-]{10,}$/.test(e)}function E(e){const t=g(e);if(!t)return null;const o=P.extractDriveId(t);return Z(o)?`drive:${o}`:t.includes("://")?t:null}function re(e,t=320){const o=document.querySelector(e);if(!o)return null;const a=()=>{o.style.height="auto";const n=o.scrollHeight;n>t?(o.style.height=`${t}px`,o.style.overflowY="auto"):(o.style.height=`${n}px`,o.style.overflowY="hidden")};return o.addEventListener("input",a),window.addEventListener("resize",a),requestAnimationFrame(a),setTimeout(a,60),{resize:a}}let J=null;async function L(){try{const e=window.google;return!e||!e.accounts?(console.info("[auth] GIS ainda não carregou; mantendo local-first."),!1):(await j.authenticate(),!0)}catch(e){return console.info("[auth] não foi possível autenticar agora; seguindo com cache.",e),!1}}function x(){return new Promise((e,t)=>{const o=indexedDB.open(oe,ae);o.onupgradeneeded=()=>{const a=o.result;a.objectStoreNames.contains(F)||a.createObjectStore(F),a.objectStoreNames.contains(A)||a.createObjectStore(A,{keyPath:"rowIndex"}),a.objectStoreNames.contains(I)||a.createObjectStore(I)},o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)})}async function se(e){const t=await x();return new Promise((o,a)=>{const s=t.transaction(F,"readonly").objectStore(F).get(e);s.onsuccess=()=>o(s.result??null),s.onerror=()=>a(s.error)})}async function z(e,t){const o=await x();return new Promise((a,n)=>{const r=o.transaction(F,"readwrite");r.objectStore(F).put(t,e),r.oncomplete=()=>a(),r.onerror=()=>n(r.error)})}async function ie(e){const t=await x();return new Promise((o,a)=>{const r=t.transaction(A,"readonly").objectStore(A).get(e);r.onsuccess=()=>o(r.result??null),r.onerror=()=>a(r.error)})}async function Q(e){const t=await x();return new Promise((o,a)=>{const n=t.transaction(A,"readwrite");n.objectStore(A).put(e),n.oncomplete=()=>o(),n.onerror=()=>a(n.error)})}async function X(e){const t=await x();return new Promise((o,a)=>{const r=t.transaction(I,"readonly").objectStore(I).get(e);r.onsuccess=()=>o(r.result??null),r.onerror=()=>a(r.error)})}async function R(e,t){const o=await x();return new Promise((a,n)=>{const r=o.transaction(I,"readwrite");r.objectStore(I).put(t,e),r.oncomplete=()=>a(),r.onerror=()=>n(r.error)})}async function ce(e){const t=await x();return new Promise((o,a)=>{const n=t.transaction(I,"readwrite");n.objectStore(I).delete(e),n.oncomplete=()=>o(),n.onerror=()=>a(n.error)})}async function _(e){await j.authenticate();const t=j.getAccessToken(),o=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}?alt=media`,a=await fetch(o,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok)throw new Error(`Drive media ${a.status}`);return await a.blob()}const K=u("#tab"),H=u("#rowIndex"),U=u("#nome"),V=u("#email"),C=u("#observacoes"),D=u("#imagem"),b=u("#imgPreview"),$=q("#imgPlaceholder"),O=u("#imgDelete"),le=u("#imgRetake"),W=q("#imgActions"),ue=q("#imgDrop"),B=u("#fotoFileIdAtual"),de=u("#form");let M=!1,T=null;function v(e){!b||!$||!O||!W||(b.classList.toggle("d-none",e),$.classList.toggle("d-none",!e),O.classList.toggle("d-none",e),W.classList.toggle("d-none",e))}async function ee(e){if(!b||!$||!O||!W)return;const t=E(e);if(!t){v(!0);return}const o=await X(t);if(o){b.src=URL.createObjectURL(o),v(!1);return}try{if(t.startsWith("drive:")&&await L()){const n=await _(t.slice(6));await R(t,n),b.src=URL.createObjectURL(n),v(!1);return}if(!t.startsWith("drive:")){const n=await fetch(t);if(n.ok){const r=await n.blob();await R(t,r),b.src=URL.createObjectURL(r),v(!1);return}}}catch{}const a=P.extractDriveId(g(e));if(Z(a)){b.src=P.viewUrl(a,256),v(!1);return}v(!0)}const y=new te,N=new P;async function fe(){const e=k("tab")||l,t=Number(k("rowIndex")||NaN);if(K&&(K.value=e),H&&(H.value=String(t)),!Number.isInteger(t)||t<1){p("danger","Parâmetros inválidos (rowIndex precisa ser >= 1).");return}let o=await ie(t);o?(console.log("[editar] carregando do cache local"),Y(o)):console.log("[editar] não há cache local para a linha; exibindo vazio até validar…");let a=y.getMetaLocal(),n=a[l];n||(console.log("[meta] não há entrada local; construindo meta local…"),a=await y.buildMetaLocalFromSheet(),n=a[l]);const r=await se(l);let s=null,w=!1;if(n&&Number.isInteger(n.index)&&n.index>=1){if(await L())try{s=await y.getMetaLastModByIndexFast(n.index),console.log("[meta] remoto (fast) =",s,"(linha",n.index,")")}catch(c){console.warn("[meta] fast-path falhou; usando meta local:",c),s=n.lastMod||null}else s=n.lastMod||null;w=s==null||s!==r}else w=!0;if(console.log("[editar] needNetwork:",w,"localVer:",r,"remoteVer:",s),(w||!o)&&await L())try{const c=await y.getObjectByIndex(l,t);if(!c){p("warning","Registro não encontrado no Sheets.");return}const m={rowIndex:c.rowIndex,...c.object||{}};console.log("[editar] linha atualizada do Sheets:",m),await Q(m);const d=E(m[i.fotoFileId]??m.Foto);if(d&&!await X(d))try{if(d.startsWith("drive:")&&await L()){const f=await _(d.slice(6));await R(d,f)}else if(!d.startsWith("drive:")){const f=await fetch(d);f.ok&&await R(d,await f.blob())}}catch{}if(Y(m),s)await z(l,s),console.log("[meta] versão local atualizada para:",s);else{const f=await y.upsertMeta(l);await z(l,f.lastMod)}}catch(c){console.error(c),o||p("danger","Falha ao carregar o registro.")}}function Y(e){U&&(U.value=g(e[i.nome]??e.nome)),V&&(V.value=g(e[i.email]??e.email)),C&&(C.value=g(e[i.obs]??e.Observacoes??e.observações??e.observacoes),J?.resize());const t=g(e[i.fotoFileId]??e.Foto);B&&(B.value=t),ee(t)}const we=ue;we?.addEventListener("click",()=>D?.click());le?.addEventListener("click",()=>D?.click());O?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),M=!0,T=null,D&&(D.value=""),v(!0),p("warning","A foto será removida ao salvar.")});D?.addEventListener("change",()=>{M=!1;const e=D.files?.[0]||null;if(T=e,e&&b){const t=new FileReader;t.onload=()=>{b.src=String(t.result),v(!1)},t.readAsDataURL(e)}else{const t=B?.value||"";ee(t)}});de?.addEventListener("submit",async e=>{e.preventDefault();const t=k("tab")||l,o=Number(k("rowIndex")||NaN);if(!Number.isInteger(o)||o<1){p("danger","Parâmetros inválidos (rowIndex precisa ser >= 1).");return}const a=g(U?.value),n=g(V?.value),r=g(C?.value),s=B?.value||"",w=P.extractDriveId(s)||"",c={[i.nome]:a,[i.email]:n,[i.obs]:r,[i.fotoFileId]:s};try{if(!await L()){p("warning","Não foi possível autenticar agora. Tente novamente.");return}if(M&&w){try{await N.deleteFile?.(w)}catch{}c[i.fotoFileId]=""}if(T){if(w&&!M)try{await N.deleteFile?.(w)}catch{}const S=await N.ensurePath(["pwa-sheets-helloworld","Cadastro","Imagens"]),G=await N.uploadImage(T,S);try{await N.setPublic(G.id)}catch{}c[i.fotoFileId]=G.id}await y.updateRowByIndex(t,o,c);const m=await y.upsertMeta(l);await z(l,m.lastMod);const d={rowIndex:o,[i.nome]:a,[i.email]:n,[i.obs]:r,[i.fotoFileId]:c[i.fotoFileId]};await Q(d);const f=E(s),h=E(c[i.fotoFileId]);if(!ne(f,h)){if(f)try{await ce(f)}catch{}if(h)try{if(h.startsWith("drive:")&&await L()){const S=await _(h.slice(6));await R(h,S)}else if(!h.startsWith("drive:")){const S=await fetch(h);S.ok&&await R(h,await S.blob())}}catch{}}p("success","Registro atualizado com sucesso!"),setTimeout(()=>window.location.href="./consulta.html",700)}catch(m){console.error(m),p("danger","Falha ao salvar as alterações.")}});document.addEventListener("DOMContentLoaded",async()=>{try{await j.authenticate()}catch{}J=re("#observacoes",320),await fe()});
