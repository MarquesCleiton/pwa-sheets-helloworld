import{G as g}from"./GoogleAuthManager-lBYSKgkx.js";class d{sheetId;static META_TAB="Metadados";constructor(e="19B2aMGrajvhPJfOvYXt059-fECytaN38iFsP8GInD_g"){this.sheetId=e}async getAccessToken(){await g.authenticate();const e=g.getAccessToken();if(!e)throw new Error("Token de acesso inválido ou ausente (Sheets).");return e}async getHeadersInit(){return{Authorization:`Bearer ${await this.getAccessToken()}`,"Content-Type":"application/json",Accept:"application/json"}}async request(e,t="GET",o){const n=await this.getHeadersInit(),s=await fetch(e,{method:t,headers:n,body:o?JSON.stringify(o):void 0});if(console.log(s),!s.ok){let a={};try{a=await s.json()}catch{}throw console.error("Erro na requisição ao Google Sheets:",a),new Error(a?.error?.message||`Erro ao acessar o Google Sheets (HTTP ${s.status}).`)}if(console.log("SheetsClient 56"),!(s.headers.get("content-type")||"").includes("application/json"))try{const a=await s.text();return a?JSON.parse(a):void 0}catch{return}return console.log("SheetsClient 67"),await s.json()}async getSheetMatrix(e){const t=encodeURIComponent(e),o=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${t}?majorDimension=ROWS`;return(await this.request(o,"GET")).values??[]}async getHeaders(e){const t=await this.getSheetMatrix(e);return t.length===0?[]:(t[0]??[]).map((n,s)=>{const r=String(n??"").trim();return r.length?r:`col_${s+1}`})}async getObjectsWithIndex(e){const t=await this.getSheetMatrix(e);if(t.length===0)return[];const o=await this.getHeaders(e),n=[];for(let s=1;s<t.length;s++){const a=(t[s]??[]).slice(0,o.length);for(;a.length<o.length;)a.push("");const c={};o.forEach((u,i)=>c[u]=a[i]??""),n.push({rowIndex:s,rowNumberA1:s+1,object:c})}return n}async getObjectByIndex(e,t){if(!Number.isInteger(t)||t<1)throw new Error("rowIndex inválido (0 é o cabeçalho; use >= 1).");const o=await this.getHeaders(e);if(o.length===0)throw new Error(`Cabeçalho da aba "${e}" não encontrado.`);const n=this.colToA1(o.length-1),s=`${e}!A${t+1}:${n}${t+1}`,r=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(s)}?majorDimension=ROWS`,c=(await this.request(r,"GET")).values?.[0]??[];if(c.length===0||c.every(h=>h===""||h==null))return null;const i=c.slice(0,o.length);for(;i.length<o.length;)i.push("");const l={};return o.forEach((h,p)=>{l[h]=String(i[p]??"")}),{rowIndex:t,rowNumberA1:t+1,object:l}}mapObjectToRow(e,t){return t.map(o=>e[o]??"")}async appendRowByHeader(e,t){const o=await this.getHeaders(e);if(o.length===0)throw new Error("Cabeçalhos não encontrados na planilha.");const n=[this.mapObjectToRow(t,o)],s=`${e}!A1`,r=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(s)}:append?valueInputOption=RAW`;await this.request(r,"POST",{values:n})}colToA1(e){let t="",o=e;for(;o>=0;)t=String.fromCharCode(o%26+65)+t,o=Math.floor(o/26)-1;return t}async getRowArrayByIndex(e,t){const o=await this.getHeaders(e);if(o.length===0)return null;const n=this.colToA1(o.length-1),s=`${e}!A${t+1}:${n}${t+1}`,r=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(s)}?majorDimension=ROWS`,c=(await this.request(r,"GET")).values?.[0]??[];return c.length===0||c.every(i=>i===""||i==null)?null:c.map(i=>(i??"").toString())}async updateRowByIndex(e,t,o){if(!Number.isInteger(t)||t<1)throw new Error("rowIndex inválido (0 é cabeçalho; use >= 1).");const n=await this.getHeaders(e);if(n.length===0)throw new Error(`Cabeçalho da aba "${e}" não encontrado.`);const s=await this.getRowArrayByIndex(e,t);if(!s)throw new Error(`Linha ${t} não existe (ou está totalmente vazia).`);const r=n.map((i,l)=>{const h=Object.prototype.hasOwnProperty.call(o,i);return String(h?o[i]??"":s[l]??"")}),a=this.colToA1(n.length-1),c=`${e}!A${t+1}:${a}${t+1}`,u=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(c)}?valueInputOption=USER_ENTERED`;await this.request(u,"PUT",{range:c,majorDimension:"ROWS",values:[r]})}async softDeleteRowByIndex(e,t){if(!Number.isInteger(t)||t<1)throw new Error("rowIndex inválido (0 é cabeçalho; use >= 1).");const o=await this.getHeaders(e);if(o.length===0)throw new Error(`Cabeçalho da aba "${e}" não encontrado.`);if(!await this.getRowArrayByIndex(e,t))throw new Error(`Linha ${t} não existe (ou está totalmente vazia).`);const s=o.map(()=>"-"),r=this.colToA1(o.length-1),a=`${e}!A${t+1}:${r}${t+1}`,c=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(a)}?valueInputOption=USER_ENTERED`;await this.request(c,"PUT",{range:a,majorDimension:"ROWS",values:[s]})}metaCacheKey(){return`sheets:${this.sheetId}:meta`}getMetaLocal(){try{const e=localStorage.getItem(this.metaCacheKey());return e?JSON.parse(e):{}}catch{return{}}}setMetaLocal(e){localStorage.setItem(this.metaCacheKey(),JSON.stringify(e))}upsertMetaLocalEntry(e,t){const o=this.getMetaLocal();o[e]=t,this.setMetaLocal(o)}async buildMetaLocalFromSheet(){const e=await this.getObjectsWithIndex(d.META_TAB),t={};for(const o of e){const n=String(o.object?.SheetName||"").trim();if(!n)continue;const s=String(o.object?.UltimaModificacao||"").trim();t[n]={index:o.rowIndex,lastMod:s}}return this.setMetaLocal(t),t}async getMetaLastModByIndexFast(e){if(!Number.isInteger(e)||e<1)throw new Error("rowIndex inválido para Metadados (>= 1).");const t=e+1,o=`${d.META_TAB}!B${t}:B${t}`,n=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(o)}?majorDimension=ROWS`,r=(await this.request(n,"GET")).values?.[0]?.[0]??"",a=String(r??"").trim();return a.length?a:null}async upsertMeta(e,t){const o=t??new Date().toISOString();let n=this.getMetaLocal(),s=n[e];if(s&&Number.isInteger(s.index)&&s.index>=1){const l=s.index+1,h=`${d.META_TAB}!B${l}:B${l}`,p=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(h)}?valueInputOption=USER_ENTERED`;return await this.request(p,"PUT",{range:h,majorDimension:"ROWS",values:[[o]]}),s={index:s.index,lastMod:o},this.upsertMetaLocalEntry(e,s),s}const r=await this.getObjectsWithIndex(d.META_TAB);let a=null;for(const l of r)if(String(l.object?.SheetName||"").trim()===e){a={rowIndex:l.rowIndex,rowNumberA1:l.rowNumberA1};break}if(a){const l=`${d.META_TAB}!B${a.rowNumberA1}:B${a.rowNumberA1}`,h=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(l)}?valueInputOption=USER_ENTERED`;await this.request(h,"PUT",{range:l,majorDimension:"ROWS",values:[[o]]});const p={index:a.rowIndex,lastMod:o};return this.upsertMetaLocalEntry(e,p),p}const c=`${d.META_TAB}!A1`,u=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(c)}:append?valueInputOption=USER_ENTERED`;await this.request(u,"POST",{values:[[e,o]]}),n=await this.buildMetaLocalFromSheet();const i=n[e];if(!i)throw new Error("Falha ao criar entrada em Metadados.");return i}}class v{fields;constructor(e={}){this.fields=e.fields??"id,name,mimeType,webViewLink,webContentLink,thumbnailLink,driveId",console.log("[DriveClient] Inicializado com fields:",this.fields)}async getAccessToken(){console.log("[DriveClient] Solicitando token de acesso..."),await g.authenticate();const e=g.getAccessToken();if(!e)throw new Error("Token de acesso inválido (Drive).");return console.log("[DriveClient] Token de acesso obtido com sucesso."),e}async request(e,t){console.log("[DriveClient] Requisição →",e,t?.method||"GET");const o=await this.getAccessToken(),n=t?.body instanceof FormData,s=e.includes("?")?"&":"?",r=`${e}${s}supportsAllDrives=true&includeItemsFromAllDrives=true`,a=await fetch(r,{...t,headers:{Authorization:`Bearer ${o}`,...n?{}:{"Content-Type":"application/json"},...t?.headers||{}}});if(console.log("[DriveClient] Resposta status:",a.status),!a.ok){let i="";try{i=await a.text()}catch{}try{i=JSON.parse(i)?.error?.message||i}catch{}throw new Error(`Drive ${a.status}: ${i||a.statusText}`)}const c=a.headers.get("content-type")||"";if(a.status===204)return;if(c.includes("application/json")){const i=await a.json();return console.log("[DriveClient] Resposta JSON:",i),i}const u=await a.text();return console.log("[DriveClient] Resposta texto:",u),u}async uploadImage(e,t){console.log("[DriveClient] Iniciando upload multipart para pasta:",t);const o={name:e.name,mimeType:e.type||"application/octet-stream",parents:[t]};console.log("[DriveClient] Metadados:",o);const n=new FormData;n.append("metadata",new Blob([JSON.stringify(o)],{type:"application/json; charset=UTF-8"})),n.append("file",e);const r=await this.request("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",{method:"POST",body:n});return console.log("[DriveClient] Upload concluído. ID:",r.id),r}async uploadImageResumable(e,t){console.log("[DriveClient] Iniciando upload resumable para pasta:",t);const o=await this.getAccessToken(),n="https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable&fields=id";console.log("[DriveClient] Criando sessão resumable...");const s=await fetch(`${n}&supportsAllDrives=true&includeItemsFromAllDrives=true`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify({name:e.name,parents:[t],mimeType:e.type||"application/octet-stream"})});if(!s.ok)throw new Error(`Init resumable: ${await s.text()}`);const r=s.headers.get("Location");if(!r)throw new Error("Resumable: header Location ausente.");console.log("[DriveClient] Sessão resumable criada. Location:",r),console.log("[DriveClient] Enviando chunks...");const a=await fetch(r,{method:"PUT",headers:{"Content-Type":e.type||"application/octet-stream"},body:e});if(!a.ok)throw new Error(`PUT resumable: ${await a.text()}`);const c=await a.json();return console.log("[DriveClient] Upload resumable concluído. ID:",c.id),c}async setPublic(e){console.log("[DriveClient] Tornando arquivo público:",e);const t=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}/permissions`;await this.request(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})}),console.log("[DriveClient] Arquivo agora é público.")}async addUserPermission(e,t,o="writer",n=!1){console.log(`{DriveClient] Adicionando permissão ${o} para ${t} no arquivo:`,e);const s=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}/permissions?sendNotificationEmail=${n?"true":"false"}`;await this.request(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"user",role:o,emailAddress:t})}),console.log("[DriveClient] Permissão adicionada.")}async deleteFile(e){console.log("[DriveClient] Excluindo arquivo:",e);const t=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}`;await this.request(t,{method:"DELETE"}),console.log("[DriveClient] Arquivo excluído.")}static viewUrl(e,t){const o=t?`https://lh3.googleusercontent.com/d/${encodeURIComponent(e)}=s${t}`:`https://lh3.googleusercontent.com/d/${encodeURIComponent(e)}`;return console.log("[DriveClient] Gerando viewUrl:",o),o}static directUrl(e){const t=`https://drive.google.com/uc?id=${encodeURIComponent(e)}`;return console.log("[DriveClient] Gerando directUrl:",t),t}static extractDriveId(e){console.log("[DriveClient] Extraindo ID do valor:",e);const t=(e||"").trim();if(!t)return null;if(!t.includes("://"))return t;const o=t.match(/[?&]id=([a-zA-Z0-9_-]+)/);if(o)return o[1];const n=t.match(/\/d\/([a-zA-Z0-9_-]+)/);if(n)return n[1];const s=t.match(/\/download\?id=([a-zA-Z0-9_-]+)/);return s?s[1]:null}}export{v as D,d as S};
