import{G as l}from"./GoogleAuthManager-YBajxLns.js";class r{fields;appRootName;static ROOT_CACHE_KEY="drive:appRootId";static PATH_PREFIX="drive:path:";static CACHE_TTL_MS=1440*60*1e3;constructor(e="id,name,mimeType,webViewLink,webContentLink,thumbnailLink",t="pwa-sheets-helloworld"){this.fields=e,this.appRootName=t}async getAccessToken(){await l.authenticate();const e=l.getAccessToken();if(!e)throw new Error("Token de acesso invÃ¡lido (Drive).");return e}async request(e,t){const n=await this.getAccessToken(),o=t?.body instanceof FormData,a=await fetch(e,{...t,headers:{Authorization:`Bearer ${n}`,...o?{}:{"Content-Type":"application/json"},...t?.headers||{}}});if(!a.ok){let i="";try{i=await a.text()}catch{}try{i=JSON.parse(i)?.error?.message||i}catch{}throw new Error(`Drive ${a.status}: ${i||a.statusText}`)}const s=a.headers.get("content-type")||"";if(a.status!==204)return s.includes("application/json")?await a.json():await a.text()}getCache(e){try{const t=localStorage.getItem(e);if(!t)return null;const{id:n,ts:o}=JSON.parse(t);return Date.now()-Number(o)>r.CACHE_TTL_MS?null:n}catch{return null}}setCache(e,t){try{localStorage.setItem(e,JSON.stringify({id:t,ts:Date.now()}))}catch{}}async findFolderInParent(e,t){const n=[`name='${t.replace(/'/g,"\\'")}'`,"mimeType='application/vnd.google-apps.folder'","trashed=false",`'${e}' in parents`].join(" and "),o=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(n)}&fields=files(id,name)&pageSize=1`;return((await this.request(o)).files||[])[0]??null}async createFolder(e,t){return await this.request("https://www.googleapis.com/drive/v3/files?fields=id,name",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,parents:[e],mimeType:"application/vnd.google-apps.folder"})})}async ensureAppRoot(){const e=this.getCache(r.ROOT_CACHE_KEY);if(e)return e;const t=[`name='${this.appRootName.replace(/'/g,"\\'")}'`,"mimeType='application/vnd.google-apps.folder'","trashed=false","'root' in parents"].join(" and "),n=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(t)}&fields=files(id,name)&pageSize=1`,a=((await this.request(n)).files||[])[0];if(a)return this.setCache(r.ROOT_CACHE_KEY,a.id),a.id;const s=await this.createFolder("root",this.appRootName);return this.setCache(r.ROOT_CACHE_KEY,s.id),s.id}async ensurePath(e){const t=await this.ensureAppRoot(),n=(Array.isArray(e)?e:e.split("/")).map(s=>s.trim()).filter(Boolean);let o=t,a=[];for(const s of n){a.push(s);const i=`${r.PATH_PREFIX}${this.appRootName}/${a.join("/")}`,c=this.getCache(i);if(c){o=c;continue}const p=await this.findFolderInParent(o,s);if(p){this.setCache(i,p.id),o=p.id;continue}const d=await this.createFolder(o,s);this.setCache(i,d.id),o=d.id}return o}async findRecentByName(e,t,n){const o=new Date(n).toISOString(),a=`name='${t.replace(/'/g,"\\'")}' and '${e}' in parents and trashed=false and createdTime>'${o}'`,s=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(a)}&orderBy=createdTime desc&fields=files(id)&pageSize=1`;return((await this.request(s)).files||[])[0]??null}async uploadImage(e,t){const n=Date.now(),o={name:e.name,mimeType:e.type||"application/octet-stream",parents:[t]},a=new FormData;a.append("metadata",new Blob([JSON.stringify(o)],{type:"application/json; charset=UTF-8"})),a.append("file",e);const s="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id";try{return await this.request(s,{method:"POST",body:a})}catch{const i=await this.findRecentByName(t,e.name,n-6e4);return i||await this.uploadImageResumable(e,t)}}async uploadImageResumable(e,t){const n=await this.getAccessToken(),o=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable&fields=id",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify({name:e.name,parents:[t],mimeType:e.type||"application/octet-stream"})});if(!o.ok)throw new Error(`Init resumable: ${await o.text()}`);const a=o.headers.get("Location");if(!a)throw new Error("Resumable: header Location ausente.");const s=await fetch(a,{method:"PUT",headers:{"Content-Type":e.type||"application/octet-stream"},body:e});if(!s.ok)throw new Error(`PUT resumable: ${await s.text()}`);return await s.json()}async setPublic(e){const t=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}/permissions`;await this.request(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})})}static viewUrl(e,t){return t?`https://lh3.googleusercontent.com/d/${encodeURIComponent(e)}=s${t}`:`https://lh3.googleusercontent.com/d/${encodeURIComponent(e)}`}static extractDriveId(e){const t=(e||"").trim();if(!t)return null;if(!t.includes("://"))return t;const n=t.match(/[?&]id=([a-zA-Z0-9_-]+)/);if(n)return n[1];const o=t.match(/\/d\/([a-zA-Z0-9_-]+)/);if(o)return o[1];const a=t.match(/\/download\?id=([a-zA-Z0-9_-]+)/);return a?a[1]:null}}export{r as D};
