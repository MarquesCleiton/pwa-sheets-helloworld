const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/DriveClient-PNd5-b1r.js","assets/navigation-BiZBkmgm.js"])))=>i.map(i=>d[i]);
import{n as W}from"./navigation-BiZBkmgm.js";import{l as j,S as Y}from"./loadNavbar-CnyS9KZm.js";const X="modulepreload",ee=function(t){return"/pwa-sheets-helloworld/"+t},$={},K=function(e,o,n){let a=Promise.resolve();if(o&&o.length>0){let y=function(d){return Promise.all(d.map(f=>Promise.resolve(f).then(b=>({status:"fulfilled",value:b}),b=>({status:"rejected",reason:b}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),r=s?.nonce||s?.getAttribute("nonce");a=y(o.map(d=>{if(d=ee(d),d in $)return;$[d]=!0;const f=d.endsWith(".css"),b=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${b}`))return;const w=document.createElement("link");if(w.rel=f?"stylesheet":X,f||(w.as="script"),w.crossOrigin="",w.href=d,r&&w.setAttribute("nonce",r),document.head.appendChild(w),f)return new Promise((G,H)=>{w.addEventListener("load",G),w.addEventListener("error",()=>H(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(s){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=s,window.dispatchEvent(r),!r.defaultPrevented)throw s}return a.then(s=>{for(const r of s||[])r.status==="rejected"&&i(r.reason);return e().catch(i)})},te="1zId11Ydti8d0FOQoQjd9lQmPo6GiJx26";function oe(t){if(!t)return null;const e=/\/d\/([a-zA-Z0-9_-]{10,})/,o=/id=([a-zA-Z0-9_-]{10,})/,n=/^([a-zA-Z0-9_-]{10,})$/;let a=t.match(e);return a||(a=t.match(o),a)||(a=t.match(n),a)?a[1]:null}window.deleteDriveFile=async t=>{const{DriveClient:e}=await K(async()=>{const{DriveClient:a}=await import("./DriveClient-PNd5-b1r.js");return{DriveClient:a}},__vite__mapDeps([0,1])),o=new e,n=oe(t);n&&await o.deleteFile(n)};window.uploadDriveImage=async t=>{const{DriveClient:e}=await K(async()=>{const{DriveClient:i}=await import("./DriveClient-PNd5-b1r.js");return{DriveClient:i}},__vite__mapDeps([0,1])),o=new e,n=await o.uploadImage(t,te);await o.setPublic(n.id);const a=e.viewUrl(n.id);return{id:n.id,url:a}};const ne="pwa-sheets-cache",ae=2,I="users",g="images";class re{db=null;async open(){return this.db?this.db:(this.db=await new Promise((e,o)=>{const n=indexedDB.open(ne,ae);n.onupgradeneeded=()=>{const a=n.result;a.objectStoreNames.contains(I)||a.createObjectStore(I,{keyPath:"key"}).createIndex("by_email","email"),a.objectStoreNames.contains(g)||a.createObjectStore(g,{keyPath:"key"})},n.onsuccess=()=>e(n.result),n.onerror=()=>o(n.error)}),this.db)}async getAllUsers(){const e=await this.open();return new Promise((o,n)=>{const s=e.transaction(I,"readonly").objectStore(I).getAll();s.onsuccess=()=>o((s.result||[]).map(r=>r.data)),s.onerror=()=>n(s.error)})}async upsertUser(e){const o=await this.open();return new Promise((n,a)=>{const i=o.transaction(I,"readwrite"),s=i.objectStore(I),r=(e.email||e.nome||"").toLowerCase()||`row_${Q(JSON.stringify(e))}`;s.put({key:r,email:e.email||null,data:e}),i.oncomplete=()=>n(),i.onerror=()=>a(i.error)})}async getImage(e){const o=await this.open();return new Promise((n,a)=>{const r=o.transaction(g,"readonly").objectStore(g).get(e);r.onsuccess=()=>n(r.result&&r.result.blob||null),r.onerror=()=>a(r.error)})}async putImage(e,o){const n=await this.open();return new Promise((a,i)=>{const s=n.transaction(g,"readwrite");s.objectStore(g).put({key:e,blob:o}),s.oncomplete=()=>a(),s.onerror=()=>i(s.error)})}async delImage(e){const o=await this.open();return new Promise((n,a)=>{const i=o.transaction(g,"readwrite");i.objectStore(g).delete(e),i.oncomplete=()=>n(),i.onerror=()=>a(i.error)})}}function Q(t){let e=0,o=0;for(;o<t.length;)e=(e<<5)-e+t.charCodeAt(o++)|0;return Math.abs(e)}function D(t){return t.fotoId?`id:${t.fotoId}`:t.fotoUrl?`url:${Q(t.fotoUrl)}`:null}async function B(t){const e=await fetch(t,{cache:"no-store"});if(!e.ok)throw new Error(`Falha ao baixar imagem (${e.status})`);return await e.blob()}const se=(t,e)=>({rowIndex:t,nome:e?.Nome??e?.nome??"",email:e?.Email??e?.email??"",observacoes:e?.Observacoes??e?.Observações??e?.observacoes??e?.observações??"",fotoUrl:e?.FotoUrl??e?.fotoUrl??e?.ImageUrl??e?.imageUrl??e?.Imagem??e?.Foto??null,fotoId:e?.FotoId??e?.fotoId??e?.ImageId??e?.imageId??null}),c=t=>document.querySelector(t);function v(t){return JSON.parse(JSON.stringify(t))}function ie(t){return new Promise(e=>setTimeout(e,t))}const m=new re,U=new Y;let L=null,l=null,S=null,F=!1;const E=c("#alert"),V=c("#form"),T=c("#tab"),_=c("#rowIndex"),A=c("#nome"),N=c("#email"),k=c("#observacoes"),le=c("#imgDrop"),P=c("#imgPlaceholder"),u=c("#imgPreview"),x=c("#imgDelete"),C=c("#imgActions"),p=c("#imagem"),M=c("#fotoFileIdAtual");function h(t,e="warning"){E&&(E.textContent=t,E.className=`alert alert-${e}`,E.classList.remove("d-none"))}function ce(){E?.classList.add("d-none")}function q(t){(V?.querySelectorAll("button[type='submit']")||[]).forEach(o=>{o.disabled=t,o.innerHTML=t?'<span class="spinner-border spinner-border-sm me-1"></span> Salvando...':'<i class="bi bi-save"></i> Salvar'})}le?.addEventListener("click",()=>p?.click());c("#imgRetake")?.addEventListener("click",()=>p?.click());x?.addEventListener("click",t=>{t.stopPropagation(),F=!0,S=null,p&&(p.value=""),u&&(u.src="",u.classList.add("d-none")),P?.classList.remove("d-none"),x?.classList.add("d-none"),C?.classList.add("d-none")});p?.addEventListener("change",()=>{const t=p.files&&p.files[0];if(!t)return;F=!1,S=t;const e=new FileReader;e.onload=()=>{u&&(u.src=String(e.result),u.classList.remove("d-none")),P?.classList.add("d-none"),x?.classList.remove("d-none"),C?.classList.remove("d-none")},e.readAsDataURL(t)});document.addEventListener("DOMContentLoaded",()=>{j(),de()});async function de(){try{const t=new URLSearchParams(location.search),e=Number(t.get("rowIndex"));if(!Number.isFinite(e)||e<1){h("rowIndex inválido.","danger");return}T&&(T.value="Cadastro"),_&&(_.value=String(e));const o=await ue(e);o?(console.log("[Editar] cache → registro:",o),await z(o),L=v(o),l=v(o)):console.warn("[Editar] registro não encontrado no cache para rowIndex",e);const n=await U.upsertMetaLocal?.("Cadastro")??null;if(n&&n.index>=1){const a=await U.getMetaLastModByIndexFast(n.index),i=!!a&&(!o||a>n.lastMod);if(console.log("[Editar] meta local:",n," | remoto:",a," | changed:",i),i){const s=await U.getObjectByIndex("Cadastro",e);if(s?.object)if(fe(s.object))h("Este registro foi excluído recentemente.","warning");else{const r=se(e,s.object);await Z(r),me(l,r)&&r.fotoUrl&&await we(r),await z(r),L=v(r),l=v(r)}}}l||h("Não foi possível carregar o registro.","danger")}catch(t){console.error(t),h(t?.message||"Falha ao carregar edição.","danger")}}async function ue(t){return(await m.getAllUsers()).find(o=>o.rowIndex===t)||null}async function Z(t){await m.upsertUser(t)}function fe(t){const e=Object.values(t??{});return e.length?e.every(o=>String(o??"").trim()==="-"):!1}function me(t,e){return!t||!e?!0:(t.fotoId??null)!==(e.fotoId??null)||(t.fotoUrl??null)!==(e.fotoUrl??null)}async function we(t){const e=D(t);if(!e||!t.fotoUrl)return;if(!await m.getImage(e))try{const n=await B(t.fotoUrl);await m.putImage(e,n),console.log("[Editar] imagem cacheada:",e)}catch(n){console.warn("[Editar] falha ao baixar/cachear imagem:",n)}}async function z(t){ge(t);const e=D(t);if(e){const o=await m.getImage(e);if(o){const n=URL.createObjectURL(o);O(n,!0);return}if(t.fotoUrl)try{const n=await B(t.fotoUrl);await m.putImage(e,n);const a=URL.createObjectURL(n);O(a,!0);return}catch(n){console.warn("[Editar] falha ao baixar imagem para cache:",n)}}O(null,!1)}function ge(t){A&&(A.value=t.nome||""),N&&(N.value=t.email||""),k&&(k.value=t.observacoes||""),M&&(M.value=t.fotoId||"")}function O(t,e){e&&t?(u&&(u.src=t,u.classList.remove("d-none")),P?.classList.add("d-none"),x?.classList.remove("d-none"),C?.classList.remove("d-none")):(u&&(u.src="",u.classList.add("d-none")),P?.classList.remove("d-none"),x?.classList.add("d-none"),C?.classList.add("d-none"))}function he(){return{rowIndex:Number(_?.value||0),nome:A?.value?.trim()||"",email:N?.value?.trim()||"",observacoes:k?.value?.trim()||"",fotoId:M?.value?.trim()||l?.fotoId||null,fotoUrl:l?.fotoUrl||null}}function J(t,e){return!t||!e?!0:t.nome!==e.nome||t.email!==e.email||t.observacoes!==e.observacoes||t.fotoId!==e.fotoId||t.fotoUrl!==e.fotoUrl||S!==null||F===!0}V?.addEventListener("submit",async t=>{if(t.preventDefault(),ce(),!l){h("Nada para salvar.","danger");return}const e=he();let o=v(e);if(!J(L,o))return console.log("[Editar] nenhuma alteração → voltar à consulta"),R();try{q(!0),h("Salvando alterações...","info");const n=!!l?.fotoId,a=!!l?.fotoUrl,i=D(l||{});if(F){if((n||a)&&typeof window.deleteDriveFile=="function"&&await window.deleteDriveFile(l?.fotoId||l?.fotoUrl||""),i)try{await m.delImage(i)}catch{}o.fotoId=null,o.fotoUrl=null}if(S&&typeof window.uploadDriveImage=="function"){if((n||a)&&typeof window.deleteDriveFile=="function"&&await window.deleteDriveFile(l?.fotoId||l?.fotoUrl||""),i)try{await m.delImage(i)}catch{}const y=await window.uploadDriveImage(S);if(o.fotoId=y?.id??null,o.fotoUrl=y?.url??null,o.fotoUrl){const d=D(o);try{const f=await B(o.fotoUrl);await m.putImage(d,f)}catch(f){console.warn("[Editar] falha ao cachear nova imagem:",f)}}}if(!J(L,o))return console.log("[Editar] nenhuma alteração após regras de foto → voltar"),R();const s=o.rowIndex,r={Nome:o.nome,Email:o.email,Observacoes:o.observacoes};o.fotoUrl!==void 0&&(r.Imagem=o.fotoUrl??""),o.fotoId!==void 0&&(r.FotoId=o.fotoId??""),console.log("[Editar] updateRowByIndex(Cadastro):",{rowIndex:s,dataToUpdate:r}),await U.updateRowByIndex("Cadastro",s,r),console.log("[Editar] upsertMetaSheet('Cadastro')"),await U.upsertMetaSheet?.("Cadastro"),l=v(o),L=v(o),await Z(l),h("Informações atualizadas.","success"),await ie(800),R()}catch(n){console.error(n),h(n?.message||"Falha ao salvar alterações.","danger")}finally{q(!1)}});function R(){const t=new URLSearchParams({voltei:"1"});W(`src/presentation/pages/consulta.html?${t.toString()}`)}
