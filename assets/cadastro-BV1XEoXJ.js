import{G as k}from"./GoogleAuthManager-YBajxLns.js";import{S as q}from"./SheetsClient-BqbA6fvN.js";import{l as x}from"./loadNavbar-6w5EyZrw.js";import"./navigation-Cl-AB2MO.js";class d{fields;appRootName;constructor(e="id,name,mimeType,webViewLink,webContentLink,thumbnailLink",t="pwa-sheets-helloworld"){this.fields=e,this.appRootName=t}async getAccessToken(){await k.authenticate();const e=k.getAccessToken();if(!e)throw new Error("Token de acesso inválido (Drive).");return e}async request(e,t){const o=await this.getAccessToken(),s=t?.body instanceof FormData,a=await fetch(e,{...t,headers:{Authorization:`Bearer ${o}`,...s?{}:{"Content-Type":"application/json"},...t?.headers||{}}});if(!a.ok){let i="";try{i=await a.text()}catch{}try{i=JSON.parse(i)?.error?.message||i}catch{}throw new Error(`Drive ${a.status}: ${i||a.statusText}`)}const n=a.headers.get("content-type")||"";if(a.status!==204)return n.includes("application/json")?await a.json():await a.text()}static ROOT_CACHE_KEY="drive:appRootId";static PATH_PREFIX="drive:path:";static CACHE_TTL_MS=1440*60*1e3;getCache(e){try{const t=localStorage.getItem(e);if(!t)return null;const{id:o,ts:s}=JSON.parse(t);return Date.now()-Number(s)>d.CACHE_TTL_MS?null:o}catch{return null}}setCache(e,t){try{localStorage.setItem(e,JSON.stringify({id:t,ts:Date.now()}))}catch{}}async findFolderInParent(e,t){const o=[`name='${t.replace(/'/g,"\\'")}'`,"mimeType='application/vnd.google-apps.folder'","trashed=false",`'${e}' in parents`].join(" and "),s=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(o)}&fields=files(id,name)&pageSize=1`;return((await this.request(s)).files||[])[0]??null}async createFolder(e,t){return await this.request("https://www.googleapis.com/drive/v3/files?fields=id,name",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,parents:[e],mimeType:"application/vnd.google-apps.folder"})})}async ensureAppRoot(){const e=this.getCache(d.ROOT_CACHE_KEY);if(e)return e;const t=[`name='${this.appRootName.replace(/'/g,"\\'")}'`,"mimeType='application/vnd.google-apps.folder'","trashed=false","'root' in parents"].join(" and "),o=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(t)}&fields=files(id,name)&pageSize=1`,a=((await this.request(o)).files||[])[0];if(a)return this.setCache(d.ROOT_CACHE_KEY,a.id),a.id;const i=await this.request("https://www.googleapis.com/drive/v3/files?fields=id,name",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.appRootName,mimeType:"application/vnd.google-apps.folder",parents:["root"]})});return this.setCache(d.ROOT_CACHE_KEY,i.id),i.id}async ensurePath(e){const t=await this.ensureAppRoot(),o=(Array.isArray(e)?e:e.split("/")).map(n=>n.trim()).filter(Boolean);let s=t,a=[];for(const n of o){a.push(n);const i=`${d.PATH_PREFIX}${this.appRootName}/${a.join("/")}`,l=this.getCache(i);if(l){s=l;continue}const m=await this.findFolderInParent(s,n);if(m){this.setCache(i,m.id),s=m.id;continue}const b=await this.createFolder(s,n);this.setCache(i,b.id),s=b.id}return s}async findRecentByName(e,t,o){const s=new Date(o).toISOString(),a=`name='${t.replace(/'/g,"\\'")}' and '${e}' in parents and trashed=false and createdTime>'${s}'`,n=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(a)}&orderBy=createdTime desc&fields=files(id)&pageSize=1`;return((await this.request(n)).files||[])[0]??null}async uploadImage(e,t){const o=Date.now(),s={name:e.name,mimeType:e.type||"application/octet-stream",parents:[t]},a=new FormData;a.append("metadata",new Blob([JSON.stringify(s)],{type:"application/json; charset=UTF-8"})),a.append("file",e);const n="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id";try{return await this.request(n,{method:"POST",body:a})}catch{const i=await this.findRecentByName(t,e.name,o-6e4);return i||await this.uploadImageResumable(e,t)}}async uploadImageResumable(e,t){const o=await this.getAccessToken(),s=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable&fields=id",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify({name:e.name,parents:[t],mimeType:e.type||"application/octet-stream"})});if(!s.ok)throw new Error(`Init resumable: ${await s.text()}`);const a=s.headers.get("Location");if(!a)throw new Error("Resumable: header Location ausente.");const n=await fetch(a,{method:"PUT",headers:{"Content-Type":e.type||"application/octet-stream"},body:e});if(!n.ok)throw new Error(`PUT resumable: ${await n.text()}`);return await n.json()}async setPublic(e){const t=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}/permissions`;await this.request(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})})}static viewUrl(e){return`https://drive.google.com/uc?export=view&id=${encodeURIComponent(e)}`}}const r=c=>document.querySelector(c),H=r("#cadastroForm"),B=r("#nome"),F=r("#email"),D=r("#obs"),p=r("#imagem"),T=r("#imgDrop"),f=r("#imgPreview"),L=r("#imgDelete"),_=r("#imgRetake"),U=r("#imgActions"),j=r("#imgPlaceholder"),v=r("#authAlert"),N=r("#status"),h=r("#btnSalvar");function C(c,e="warning"){v&&(v.className=`alert alert-${e}`,v.textContent=c,v.classList.remove("d-none"))}function J(){v?.classList.add("d-none")}function y(c){N&&(N.textContent=c)}function M(c){j?.classList.add("d-none"),f&&(f.src=c,f.classList.remove("d-none")),L?.classList.remove("d-none"),U?.classList.remove("d-none"),T&&(T.style.minHeight="220px")}function $(){p&&(p.value=""),f&&(f.src="",f.classList.add("d-none")),L?.classList.add("d-none"),U?.classList.add("d-none"),j?.classList.remove("d-none"),T&&(T.style.minHeight="140px")}document.addEventListener("DOMContentLoaded",()=>{x(),T?.addEventListener("click",e=>{e.target.closest("#imgDelete")||p?.click()}),_?.addEventListener("click",()=>p?.click()),L?.addEventListener("click",e=>{e.stopPropagation(),$()}),p?.addEventListener("change",()=>{const e=p.files?.[0];if(!e){$();return}const t=URL.createObjectURL(e);M(t)}),document.getElementById("btnSair")?.addEventListener("click",()=>{try{localStorage.removeItem("user"),localStorage.removeItem("accessToken")}catch{}window.location.href="/index.html"})});const E=new d,z=E.ensurePath(["Cadastro","Imagens"]);let S=!1;H?.addEventListener("submit",async c=>{if(c.preventDefault(),S)return;S=!0,J(),y("");const e="Cadastro",t=new q;h&&(h.disabled=!0,h.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span>Salvando…');try{const o=(B?.value||"").trim(),s=(F?.value||"").trim(),a=(D?.value||"").trim();if(!o||!s){C("Preencha Nome e E-mail.","warning");return}const[n,i]=await Promise.all([t.getHeaders(e),z]),l=p?.files?.[0]||null;let m="";if(l){if(!l.type.startsWith("image/"))throw new Error("Selecione uma imagem válida.");if(l.size>5*1024*1024)throw new Error("Imagem muito grande (máx. 5 MB).");y("Enviando imagem…");const u=await E.uploadImage(l,i);await E.setPublic(u.id),m=d.viewUrl(u.id)}const b=n.map(u=>u.toLowerCase()),g=u=>{const P=b.indexOf(u.toLowerCase());return P>=0?n[P]:null},w={},R=g("Nome");R&&(w[R]=o);const O=g("Email");O&&(w[O]=s);const I=g("Observações")||g("Observacoes");I&&(w[I]=a);const A=g("Imagem");A&&m&&(w[A]=m),y("Gravando cadastro…"),await t.appendRowByHeader(e,w),C("Cadastro criado com sucesso!","success"),y("Cadastro criado com sucesso!")}catch(o){C(o?.message||"Erro ao salvar cadastro.","danger"),y("")}finally{S=!1,h&&(h.disabled=!1,h.innerHTML='<i class="bi bi-check2-circle me-1"></i>Salvar')}});
