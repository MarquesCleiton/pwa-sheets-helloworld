import{G as m}from"./GoogleAuthManager-YBajxLns.js";class h{sheetId;static META_TAB="Metadados";static META_LASTMOD_COL="B";static META_CACHE_KEY="sheets:metaLocalMap";static META_HEADERS_KEY="sheets:metaHeaders";constructor(t="19B2aMGrajvhPJfOvYXt059-fECytaN38iFsP8GInD_g"){this.sheetId=t}async getAccessToken(){await m.authenticate();const t=m.getAccessToken();if(!t)throw new Error("Token de acesso inválido ou ausente.");return t}async getHeadersInit(){return{Authorization:`Bearer ${await this.getAccessToken()}`,"Content-Type":"application/json",Accept:"application/json"}}async request(t,e="GET",s){const o=await this.getHeadersInit(),a=await fetch(t,{method:e,headers:o,body:s?JSON.stringify(s):void 0});if(!a.ok){let n={};try{n=await a.json()}catch{}throw new Error(n?.error?.message||`Sheets HTTP ${a.status}`)}if(!(a.headers.get("content-type")||"").includes("application/json"))try{const n=await a.text();return n?JSON.parse(n):void 0}catch{return}return await a.json()}colToA1(t){let e="",s=t;for(;s>=0;)e=String.fromCharCode(s%26+65)+e,s=Math.floor(s/26)-1;return e}async getSheetMatrix(t){const e=encodeURIComponent(t),s=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${e}?majorDimension=ROWS`;return(await this.request(s,"GET")).values??[]}async getHeaders(t){const e=await this.getSheetMatrix(t);return e.length===0?[]:(e[0]??[]).map((o,a)=>{const r=String(o??"").trim();return r.length?r:`col_${a+1}`})}async getRowArrayByIndex(t,e){const s=await this.getHeaders(t);if(s.length===0)return null;const o=this.colToA1(s.length-1),a=`${t}!A${e+1}:${o}${e+1}`,r=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(a)}?majorDimension=ROWS`,i=(await this.request(r,"GET")).values?.[0]??[];return i.length===0||i.every(l=>l===""||l==null)?null:i.map(l=>(l??"").toString())}mapObjectToRow(t,e){return e.map(s=>t[s]??"")}async appendRowByHeader(t,e){const s=await this.getHeaders(t);if(s.length===0)throw new Error(`Cabeçalhos não encontrados em "${t}".`);const o=[this.mapObjectToRow(e,s)],a=`${t}!A1`,r=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(a)}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS&includeValuesInResponse=true`,c=((await this.request(r,"POST",{values:o})).updates?.updatedRange||"").match(/![A-Z]+(\d+):/),l=c?parseInt(c[1],10):NaN;return Number.isFinite(l)?l-1:-1}async updateRowByIndex(t,e,s){if(!Number.isInteger(e)||e<1)throw new Error("rowIndex inválido (>=1).");const o=await this.getHeaders(t);if(o.length===0)throw new Error(`Cabeçalho da aba "${t}" não encontrado.`);const a=await this.getRowArrayByIndex(t,e);if(!a)throw new Error(`Linha ${e} inexistente em "${t}".`);const r=o.map((l,p)=>{const d=Object.prototype.hasOwnProperty.call(s,l);return String(d?s[l]??"":a[p]??"")}),n=this.colToA1(o.length-1),i=`${t}!A${e+1}:${n}${e+1}`,c=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(i)}?valueInputOption=USER_ENTERED`;await this.request(c,"PUT",{range:i,majorDimension:"ROWS",values:[r]})}async softDeleteRowByIndex(t,e){if(!Number.isInteger(e)||e<1)throw new Error("rowIndex inválido (>=1).");const s=await this.getHeaders(t);if(s.length===0)throw new Error(`Cabeçalho da aba "${t}" não encontrado.`);if(!await this.getRowArrayByIndex(t,e))throw new Error(`Linha ${e} não existe (ou vazia).`);const a=s.map(()=>"-"),r=this.colToA1(s.length-1),n=`${t}!A${e+1}:${r}${e+1}`,i=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(n)}?valueInputOption=USER_ENTERED`;await this.request(i,"PUT",{range:n,majorDimension:"ROWS",values:[a]})}getMetaLocal(){try{const t=localStorage.getItem(h.META_CACHE_KEY);return t?JSON.parse(t):{}}catch{return{}}}setMetaLocal(t){try{localStorage.setItem(h.META_CACHE_KEY,JSON.stringify(t))}catch{}}setMetaHeadersIndex(t,e){try{localStorage.setItem(h.META_HEADERS_KEY,JSON.stringify({sheetNameIdx:t,lastModIdx:e}))}catch{}}getMetaHeadersIndex(){try{const t=localStorage.getItem(h.META_HEADERS_KEY);return t?JSON.parse(t):null}catch{return null}}async buildMetaLocalFromSheet(){const t=await this.getSheetMatrix(h.META_TAB);if(t.length===0){const n={};return this.setMetaLocal(n),n}const s=(t[0]??[]).map(n=>String(n??"").trim().toLowerCase()),o=Math.max(0,s.findIndex(n=>n==="sheetname"||n==="sheet_name"||n==="pagina"||n==="página"||n==="sheetname")),a=Math.max(0,s.findIndex(n=>n.startsWith("ultima")||n.startsWith("última")||n==="ultimamodificacao"));this.setMetaHeadersIndex(o,a);const r={};for(let n=1;n<t.length;n++){const i=t[n]??[],c=String(i[o]??"").trim(),l=String(i[a]??"").trim();c&&(r[c]={index:n,sheetName:c,lastMod:l})}return this.setMetaLocal(r),r}async getMetaLastModByIndexFast(t){if(!Number.isInteger(t)||t<1)throw new Error("rowIndex inválido para Metadados (use >= 1).");const e=t+1,s=`${h.META_TAB}!${h.META_LASTMOD_COL}${e}:${h.META_LASTMOD_COL}${e}`,o=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(s)}?majorDimension=ROWS`;return((await this.request(o,"GET")).values?.[0]?.[0]??"").toString().trim()||null}async getRemoteMetaByIndex(t){let e=this.getMetaHeadersIndex();if(!e){const c=(await this.getHeaders(h.META_TAB)).map(d=>String(d??"").trim().toLowerCase()),l=Math.max(0,c.findIndex(d=>d==="sheetname"||d==="sheet_name"||d==="pagina"||d==="página"||d==="sheetname")),p=Math.max(0,c.findIndex(d=>d.startsWith("ultima")||d.startsWith("última")||d==="ultimamodificacao"));this.setMetaHeadersIndex(l,p),e={sheetNameIdx:l,lastModIdx:p}}const{sheetNameIdx:s,lastModIdx:o}=e,a=await this.getRowArrayByIndex(h.META_TAB,t);if(!a)return null;const r=String(a[s]??"").trim(),n=String(a[o]??"").trim();return{sheetName:r,lastMod:n}}async upsertMeta(t,e){const s=e||new Date().toISOString();let o=this.getMetaLocal();const a=o[t],r={SheetName:t,UltimaModificacao:s};if(a&&a.index>=1){await this.updateRowByIndex(h.META_TAB,a.index,r);const c={index:a.index,sheetName:t,lastMod:s};return o[t]=c,this.setMetaLocal(o),c}const i={index:await this.appendRowByHeader(h.META_TAB,r),sheetName:t,lastMod:s};return o=this.getMetaLocal(),o[t]=i,this.setMetaLocal(o),i}async getObjectsWithIndex(t){const e=await this.getSheetMatrix(t);if(e.length===0)return[];const s=await this.getHeaders(t),o=[];for(let a=1;a<e.length;a++){const r=e[a]??[],n=s.map((c,l)=>r[l]??""),i={};s.forEach((c,l)=>i[c]=n[l]??""),o.push({rowIndex:a,rowNumberA1:a+1,object:i})}return o}async getObjectByIndex(t,e){if(!Number.isInteger(e)||e<1)throw new Error("rowIndex inválido (0 é o cabeçalho; use >= 1).");const s=await this.getHeaders(t);if(s.length===0)throw new Error(`Cabeçalho da aba "${t}" não encontrado.`);const o=this.colToA1(s.length-1),a=`${t}!A${e+1}:${o}${e+1}`,r=`https://sheets.googleapis.com/v4/spreadsheets/${this.sheetId}/values/${encodeURIComponent(a)}?majorDimension=ROWS`,i=(await this.request(r,"GET")).values?.[0]??[];if(i.length===0||i.every(p=>!p||p===""))return null;const c=i.slice(0,s.length);for(;c.length<s.length;)c.push("");const l={};return s.forEach((p,d)=>{l[p]=String(c[d]??"")}),{rowIndex:e,rowNumberA1:e+1,object:l}}}class u{fields;appRootName;static ROOT_CACHE_KEY="drive:appRootId";static PATH_PREFIX="drive:path:";static CACHE_TTL_MS=1440*60*1e3;constructor(t="id,name,mimeType,webViewLink,webContentLink,thumbnailLink",e="pwa-sheets-helloworld"){this.fields=t,this.appRootName=e}async getAccessToken(){await m.authenticate();const t=m.getAccessToken();if(!t)throw new Error("Token de acesso inválido (Drive).");return t}async request(t,e){const s=await this.getAccessToken(),o=e?.body instanceof FormData,a=await fetch(t,{...e,headers:{Authorization:`Bearer ${s}`,...o?{}:{"Content-Type":"application/json"},...e?.headers||{}}});if(!a.ok){let n="";try{n=await a.text()}catch{}try{n=JSON.parse(n)?.error?.message||n}catch{}throw new Error(`Drive ${a.status}: ${n||a.statusText}`)}const r=a.headers.get("content-type")||"";if(a.status!==204)return r.includes("application/json")?await a.json():await a.text()}getCache(t){try{const e=localStorage.getItem(t);if(!e)return null;const{id:s,ts:o}=JSON.parse(e);return Date.now()-Number(o)>u.CACHE_TTL_MS?null:s}catch{return null}}setCache(t,e){try{localStorage.setItem(t,JSON.stringify({id:e,ts:Date.now()}))}catch{}}async findFolderInParent(t,e){const s=[`name='${e.replace(/'/g,"\\'")}'`,"mimeType='application/vnd.google-apps.folder'","trashed=false",`'${t}' in parents`].join(" and "),o=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(s)}&fields=files(id,name)&pageSize=1`;return((await this.request(o)).files||[])[0]??null}async createFolder(t,e){return await this.request("https://www.googleapis.com/drive/v3/files?fields=id,name",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,parents:[t],mimeType:"application/vnd.google-apps.folder"})})}async ensureAppRoot(){const t=this.getCache(u.ROOT_CACHE_KEY);if(t)return t;const e=[`name='${this.appRootName.replace(/'/g,"\\'")}'`,"mimeType='application/vnd.google-apps.folder'","trashed=false","'root' in parents"].join(" and "),s=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(e)}&fields=files(id,name)&pageSize=1`,a=((await this.request(s)).files||[])[0];if(a)return this.setCache(u.ROOT_CACHE_KEY,a.id),a.id;const r=await this.createFolder("root",this.appRootName);return this.setCache(u.ROOT_CACHE_KEY,r.id),r.id}async ensurePath(t){const e=await this.ensureAppRoot(),s=(Array.isArray(t)?t:t.split("/")).map(r=>r.trim()).filter(Boolean);let o=e,a=[];for(const r of s){a.push(r);const n=`${u.PATH_PREFIX}${this.appRootName}/${a.join("/")}`,i=this.getCache(n);if(i){o=i;continue}const c=await this.findFolderInParent(o,r);if(c){this.setCache(n,c.id),o=c.id;continue}const l=await this.createFolder(o,r);this.setCache(n,l.id),o=l.id}return o}async findRecentByName(t,e,s){const o=new Date(s).toISOString(),a=`name='${e.replace(/'/g,"\\'")}' and '${t}' in parents and trashed=false and createdTime>'${o}'`,r=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(a)}&orderBy=createdTime desc&fields=files(id)&pageSize=1`;return((await this.request(r)).files||[])[0]??null}async uploadImage(t,e){const s=Date.now(),o={name:t.name,mimeType:t.type||"application/octet-stream",parents:[e]},a=new FormData;a.append("metadata",new Blob([JSON.stringify(o)],{type:"application/json; charset=UTF-8"})),a.append("file",t);const r="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id";try{return await this.request(r,{method:"POST",body:a})}catch{const n=await this.findRecentByName(e,t.name,s-6e4);return n||await this.uploadImageResumable(t,e)}}async uploadImageResumable(t,e){const s=await this.getAccessToken(),o=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable&fields=id",{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify({name:t.name,parents:[e],mimeType:t.type||"application/octet-stream"})});if(!o.ok)throw new Error(`Init resumable: ${await o.text()}`);const a=o.headers.get("Location");if(!a)throw new Error("Resumable: header Location ausente.");const r=await fetch(a,{method:"PUT",headers:{"Content-Type":t.type||"application/octet-stream"},body:t});if(!r.ok)throw new Error(`PUT resumable: ${await r.text()}`);return await r.json()}async setPublic(t){const e=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(t)}/permissions`;await this.request(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})})}static viewUrl(t,e){return e?`https://lh3.googleusercontent.com/d/${encodeURIComponent(t)}=s${e}`:`https://lh3.googleusercontent.com/d/${encodeURIComponent(t)}`}static extractDriveId(t){const e=(t||"").trim();if(!e)return null;if(!e.includes("://"))return e;const s=e.match(/[?&]id=([a-zA-Z0-9_-]+)/);if(s)return s[1];const o=e.match(/\/d\/([a-zA-Z0-9_-]+)/);if(o)return o[1];const a=e.match(/\/download\?id=([a-zA-Z0-9_-]+)/);return a?a[1]:null}}export{u as D,h as S};
