import{G as I}from"./GoogleAuthManager-YBajxLns.js";import{S as U,D as S}from"./DriveClient-CRU4MlfE.js";import{l as T}from"./loadNavbar-6w5EyZrw.js";import"./navigation-Cl-AB2MO.js";const f="Cadastro",A="pwa-rpg-cache",V=1,x="versions",u="cadastro",g="images",p=e=>document.querySelector(e),j=(e,t="warning")=>{const n=p("#alert");n&&(n.className=`alert alert-${t}`,n.textContent=e,n.classList.remove("d-none"))};function O(e){const t=(e||"").trim().split(/\s+/).filter(Boolean);return((t[0]?.[0]||"")+(t.length>1?t[t.length-1][0]:"")).toUpperCase()||"U"}function b(){return new Promise((e,t)=>{const n=indexedDB.open(A,V);n.onupgradeneeded=()=>{const o=n.result;o.objectStoreNames.contains(x)||o.createObjectStore(x),o.objectStoreNames.contains(u)||o.createObjectStore(u,{keyPath:"rowIndex"}),o.objectStoreNames.contains(g)||o.createObjectStore(g)},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function $(e){const t=await b();return new Promise((n,o)=>{const c=t.transaction(x,"readonly").objectStore(x).get(e);c.onsuccess=()=>n(c.result??null),c.onerror=()=>o(c.error)})}async function M(e,t){const n=await b();return new Promise((o,r)=>{const a=n.transaction(x,"readwrite");a.objectStore(x).put(t,e),a.oncomplete=()=>o(),a.onerror=()=>r(a.error)})}async function q(){const e=await b();return new Promise((t,n)=>{const o=e.transaction(u,"readwrite");o.objectStore(u).clear(),o.oncomplete=()=>t(),o.onerror=()=>n(o.error)})}async function z(e){const t=await b();return new Promise((n,o)=>{const r=t.transaction(u,"readwrite"),a=r.objectStore(u);e.forEach(c=>a.put(c)),r.oncomplete=()=>n(),r.onerror=()=>o(r.error)})}async function _(){const e=await b();return new Promise((t,n)=>{const a=e.transaction(u,"readonly").objectStore(u).getAll();a.onsuccess=()=>{const c=a.result||[];c.sort((i,s)=>i.rowIndex-s.rowIndex),t(c)},a.onerror=()=>n(a.error)})}async function G(e){const t=await b();return new Promise((n,o)=>{const r=t.transaction(u,"readwrite");r.objectStore(u).delete(e),r.oncomplete=()=>n(),r.onerror=()=>o(r.error)})}async function B(e){const t=await b();return new Promise((n,o)=>{const a=t.transaction(g,"readonly").objectStore(g).get(e);a.onsuccess=()=>n(a.result??null),a.onerror=()=>o(a.error)})}async function C(e,t){const n=await b();return new Promise((o,r)=>{const a=n.transaction(g,"readwrite");a.objectStore(g).put(t,e),a.oncomplete=()=>o(),a.onerror=()=>r(a.error)})}async function H(e){const t=await b();return new Promise((n,o)=>{const r=t.transaction(g,"readwrite");r.objectStore(g).delete(e),r.oncomplete=()=>n(),r.onerror=()=>o(r.error)})}function k(e){return Object.entries(e).filter(([t])=>t!=="rowIndex").map(([,t])=>(t??"").toString().trim())}function E(e){const t=k(e);return t.length===0||t.every(n=>n==="")}function L(e){const t=k(e);return t.length>0&&t.every(n=>n==="-"||n==="")}function R(e){return!!e&&/^[A-Za-z0-9_-]{10,}$/.test(e)}function D(e){const t=(e.Imagem??e.Foto??e["Imagem URL"]??e.ImagemUrl??e.image??"").toString().trim();if(!t)return null;const n=S.extractDriveId(t);return R(n)?`drive:${n}`:t.includes("://")?t:null}function W(e){const t=(e.Imagem??e.Foto??e["Imagem URL"]??e.ImagemUrl??e.image??"").toString().trim();if(!t)return null;const n=S.extractDriveId(t);return R(n)?S.viewUrl(n,72):t.includes("://")?t:null}async function P(e){await I.authenticate();const t=I.getAccessToken(),n=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}?alt=media`,o=await fetch(n,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok)throw new Error(`Drive media ${o.status}`);return await o.blob()}async function K(e){const t=new Set;for(const n of e){if(E(n)||L(n))continue;const o=D(n);o&&t.add(o)}await Promise.all(Array.from(t).map(async n=>{if(await B(n))return;if(n.startsWith("drive:")){const c=await P(n.slice(6));await C(n,c);return}const r=await fetch(n);if(!r.ok)return;const a=await r.blob();await C(n,a)}))}async function Q(e){if(E(e)||L(e))return null;const t=D(e),n=W(e);if(!t&&!n)return null;if(t){const o=await B(t);if(o)return URL.createObjectURL(o)}try{if(t?.startsWith("drive:")){const o=await P(t.slice(6));return await C(t,o),URL.createObjectURL(o)}if(n){const o=await fetch(n);if(o.ok){const r=await o.blob();return await C(t||n,r),URL.createObjectURL(r)}}}catch{}return n}function Z(e,t){const n=(e.Nome??"").toString().toLowerCase(),o=(e.Email??"").toString().toLowerCase(),r=(e.Observações??e.Observacoes??"").toString().toLowerCase(),a=t.toLowerCase();return n.includes(a)||o.includes(a)||r.includes(a)}function J(e){return`./editar.html?${new URLSearchParams({tab:f,rowIndex:String(e)}).toString()}`}async function y(e){const t=p("#tbody");if(!t)return;t.innerHTML="";for(const a of e){const c=document.createElement("tr");c.dataset.row=String(a.rowIndex);const i=document.createElement("td");i.style.width="56px";try{const w=await Q(a);if(w){const l=document.createElement("img");l.src=w,l.alt="foto",l.className="avatar",i.appendChild(l)}else{const l=document.createElement("div");l.className="avatar-fallback",l.textContent=O(String(a.Nome||"")),i.appendChild(l)}}catch{const w=document.createElement("div");w.className="avatar-fallback",w.textContent=O(String(a.Nome||"")),i.appendChild(w)}c.appendChild(i);const s=document.createElement("td");s.textContent=String(a.Nome??""),s.className="fw-medium",c.appendChild(s);const m=document.createElement("td");m.textContent=String(a.Email??""),c.appendChild(m);const v=document.createElement("td");v.textContent=String(a.Observações??a.Observacoes??""),c.appendChild(v);const h=document.createElement("td");h.className="text-end actions",h.innerHTML=`
      <div class="btn-group" role="group" aria-label="Ações">
        <a class="btn btn-outline-primary btn-sm" href="${J(a.rowIndex)}" title="Editar">
          <i class="bi bi-pencil-square"></i>
        </a>
        <button class="btn btn-outline-danger btn-sm btn-del" title="Excluir">
          <i class="bi bi-trash"></i>
        </button>
      </div>`,c.appendChild(h),t.appendChild(c)}const n=p("#tbody"),o=new U,r=new S;n?.querySelectorAll(".btn-del").forEach(a=>{a.addEventListener("click",async c=>{const i=c.currentTarget.closest("tr");if(!i)return;const s=Number(i.getAttribute("data-row")||NaN);if(!Number.isInteger(s))return;const m=d.find(N=>N.rowIndex===s);if(!m||!confirm("Confirmar exclusão?"))return;const v=(m.Imagem??m.Foto??"").toString().trim(),h=S.extractDriveId(v);if(R(h))try{await r.deleteFile?.(h)}catch{}await o.softDeleteRowByIndex(f,m.rowIndex),await G(m.rowIndex);const w=D(m);w&&await H(w);const l=await o.upsertMeta(f);await M(f,l.lastMod),d=d.filter(N=>N.rowIndex!==s),await y(d),j("Registro excluído.","success")})})}let d=[];async function X(e,t){console.log("[sync] baixando Cadastro do Sheets…");const o=(await e.getObjectsWithIndex(f)).map(r=>({rowIndex:r.rowIndex,...r.object||{}})).filter(r=>!E(r)&&!L(r));return await q(),await z(o),await K(o),t&&(await M(f,t),console.log("[sync] versão local atualizada para:",t)),o}async function F({forceNetwork:e=!1}={}){const t=new U;let n=await _();n=n.filter(s=>!E(s)&&!L(s)),d=n,console.log(`[init] renderizando ${n.length} registros do cache local`),await y(d);let o=t.getMetaLocal(),r=o[f];r||(console.log("[meta] não há entrada local; construindo meta local…"),o=await t.buildMetaLocalFromSheet(),r=o[f]);const a=await $(f);let c=null,i=!!e;if(r&&Number.isInteger(r.index)&&r.index>=1)try{c=await t.getMetaLastModByIndexFast(r.index),console.log("[meta] remoto (fast) =",c,"(linha",r.index,")"),e||(i=c==null||c!==a)}catch(s){console.warn("[meta] fast-path falhou; usando valor local do meta:",s),c=r.lastMod||null,e||(i=c==null||c!==a)}else i=!0;if(console.log("[check] localVer:",a," | remoteVer:",c," | needNetwork:",i),i)try{d=await X(t,c),await y(d),j("Lista atualizada.","success")}catch(s){console.error("[sync] falha ao sincronizar do Sheets:",s),j("Falha ao atualizar do servidor. Exibindo dados locais.","warning")}}function Y(){const e=p("#q"),t=p("#btnAtualizar"),n=p("#btnSair");e?.addEventListener("input",async()=>{const o=(e.value||"").trim();if(!o)return y(d);await y(d.filter(r=>Z(r,o)))}),t?.addEventListener("click",()=>F({forceNetwork:!0})),n?.addEventListener("click",()=>{try{I.logout?.()}catch{}localStorage.clear(),indexedDB.deleteDatabase(A),window.location.href="./index.html"})}document.addEventListener("DOMContentLoaded",async()=>{try{await I.authenticate()}catch{}Y(),T(),await F()});
